<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://shiroimon.kithub.f5.si/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/github.min.css' />
    <link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/github-style.css' />
    <link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/light.css' />
    <link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/dark.css' />
    <link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/syntax.css' />
    <title>[BigQuery] Data analyize catchup - Today I Learned | KitHub</title>
    
    <link rel="icon" type="image/x-icon" href='../../images/github-mark.png'>
    
    <meta name="theme-color" content="#1e2327">

    <link rel="stylesheet" href="https://shiroimon.kithub.f5.si/css/gist.css">
    <script type="text/javascript" src="https://shiroimon.kithub.f5.si/js/gist-dark-mode.js"></script>

    
    <meta name="description"
  content="🔍 Re-summarizeing the trajectory I learned as an introductory." />
<meta name="keywords"
  content='blog' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://shiroimon.kithub.f5.si/post/bigquery_data_analysis_catchup/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="[BigQuery] Data analyize catchup - Today I Learned | KitHub" />
<meta name="twitter:description"
  content="🔍 Re-summarizeing the trajectory I learned as an introductory." />
<meta name="twitter:site" content="https://shiroimon.kithub.f5.si/" />
<meta name="twitter:creator" content="shiro" />
<meta name="twitter:image"
  content="https://shiroimon.kithub.f5.si/">


<meta property="og:type" content="article" />
<meta property="og:title" content="[BigQuery] Data analyize catchup - Today I Learned | KitHub">
<meta property="og:description"
  content="🔍 Re-summarizeing the trajectory I learned as an introductory." />
<meta property="og:url" content="https://shiroimon.kithub.f5.si/post/bigquery_data_analysis_catchup/" />
<meta property="og:site_name" content="[BigQuery] Data analyize catchup" />
<meta property="og:image"
  content="https://shiroimon.kithub.f5.si/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2024-10-26 00:22:05 &#43;0900 JST" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://shiroimon.kithub.f5.si/">
        <img class="octicon" height="32" width="32" src="../../images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" id="search-form" action="" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://shiroimon.kithub.f5.si/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="../../images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
<main>
    
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
    <div class="px-0">
    <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
    <div class="flex-auto min-width-0 width-fit mr-3">
    <div class="d-flex">
        
        <div class="d-none d-md-block">
            <a class="avatar mr-2 flex-shrink-0" href="https://shiroimon.kithub.f5.si/">
                <img class=" avatar-user"
                  src="../../images/avatar.png"
                  width="32"
                  height="32">
            </a>
        </div>
        
        <div class="d-flex flex-column">
            
            <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                <span class="author"><a href="https://shiroimon.kithub.f5.si/"></a></span>
                <span class="path-divider">/</span>
                <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px"><a href="https://shiroimon.kithub.f5.si/post/bigquery_data_analysis_catchup/">[BigQuery] Data analyize catchup</a></strong>
            </h1>
            
            <div class="note m-0">
                Created <relative-time datetime="Sat, 26 Oct 2024 00:22:05 &#43;0900" class="no-wrap">Sat, 26 Oct 2024 00:22:05 &#43;0900</relative-time>
                
                <span class="path-divider">|</span>
                Modified <relative-time datetime="Thu, 02 Oct 2025 00:30:36 &#43;0900" class="no-wrap">Thu, 02 Oct 2025 00:30:36 &#43;0900</relative-time>
                
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>
    </div>

    
    <div class="container-lg px-3 new-discussion-timeline">
    <div class="repository-content gist-content">
    <div>
        <div class="js-gist-file-update-container js-task-list-container file-box">
        <div id="file-pytest" class="file my-2">
        
        <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
        <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
            
            <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
            <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                <svg aria-hidden="true" viewBox="0 0 16 16" class="octicon octicon-list-unordered" height="16" width="16">
                    <path fill-rule="evenodd"
                        d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z">
                    </path>
                </svg>
            </summary>
            <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                    <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list"></div>
                </div>
            </details-menu>
            26241 Words
            <span class="path-divider">|</span>
            45 min
            </div>

            
            <div class="file-actions flex-order-2 pt-0">
                
                <div class="d-none d-md-flex">
                    
                    
                    
                    <a class="muted-link mr-3" href="../../tags/bigquery">
                        <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                            <path fill-rule="evenodd"
                                d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                            </path>
                        </svg>
                        BigQuery
                    </a>
                    
                    
                    
                    <a class="muted-link mr-3" href="../../tags/sql">
                        <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                            <path fill-rule="evenodd"
                                d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                            </path>
                        </svg>
                        SQL
                    </a>
                    
                    
                    
                    <a class="muted-link mr-3" href="../../tags/dwh">
                        <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                            <path fill-rule="evenodd"
                                d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                            </path>
                        </svg>
                        DWH
                    </a>
                    
                    
                    
                    <a class="muted-link mr-3" href="../../tags/data-mart">
                        <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                            <path fill-rule="evenodd"
                                d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                            </path>
                        </svg>
                        Data Mart
                    </a>
                    
                    
                    
                </div>
                
            </div>
        </div>
        </div>

        
        <div class="Box-body px-5 pb-5" style="z-index: 1">
            <article class="markdown-body entry-content container-lg"><!-- Icon Badge -->
<p><img src="https://img.shields.io/badge/-BigQuery-669DF6.svg?logo=googlebigquery&amp;style=flat&amp;color=F0F8FF" alt="BigQuery"></p>
<!-- Image -->
<p><img src="https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2020/09/gcp-eyecatch-bigquery_1200x630.png" alt="BigQuery"></p>
<h2 id="why">Why<a class="anchor" aria-hidden="true" href="#why"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h2>
<p><code>SSIA</code></p>
<h2 id="what">What<a class="anchor" aria-hidden="true" href="#what"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h2>
<h3 id="udemy講座">Udemy講座<a class="anchor" aria-hidden="true" href="#udemy講座"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<ul>
<li><img src="https://img-c.udemycdn.com/course/240x135/2394060_adbb_4.jpg" alt="img"></li>
<li><a href="https://www.udemy.com/share/102kOc3@Jm55eXaV2GdLXwnNAoEOPHhXUleiQK0EG6JQboecG715rn2_tpL6jBbg8kL1nsqw/">BigQuery で学ぶ非エンジニアのための SQL データ分析入門</a> Udemy</li>
<li><details>
  <summary>当時の所感: 2021-09-10</summary>
  <p></p>
  <ul>
<li>はじめに
<pre tabindex="0"><code>この記事は、Udemyにて学習をした際のメモです。
コース受講したい場合は、ページ最下部に参考リンクとして掲載いたします。
</code></pre></li>
<li>学習メモ
<pre tabindex="0"><code>次章からは、完全個人メモです。（後に自分で見返すようになっております）
どんな考え方（ロジック）でクエリを書き上げたのか、どこで躓いたのか、
後に俯瞰したいためにお恥ずかしながら演習問題で間違えてしまったクエリはそのまま（コメントアウト）記載してます。
悪しからず...
</code></pre></li>
<li>おわりに
<pre tabindex="0"><code>はじめて BigQueryに触れましたが、
標準SQLの奥の深さ、データを抽出することの難しさに新たな課題感を感じております。
ですが、本講座を通して、BigQueryの仕様や、SQLの基本的な文法は体得したのではないのかな？と思います。
（自分でも手が動くのに驚きを隠せませんでした。）
前半は基礎文法と地道ではありましたが、後半はパズルゲームを解く感覚に近くとても楽しんで取り組むことができました。
</code></pre></li>
</ul>

  <p></p>
</details>
</li>
</ul>
<h4 id="section23歴史と基本設定">SECTION2~3：歴史と基本設定<a class="anchor" aria-hidden="true" href="#section23歴史と基本設定"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <ul>
<li>
<p>データベース</p>
<ul>
<li>OSS （Open Source Softwear）
<ul>
<li>MySQL、PostgreSQL、SQLitte &hellip;etc.</li>
</ul>
</li>
<li>PaaS （）
<ul>
<li><strong>Google BigQuery</strong>、Amazon Web Server、TreasureData &hellip;etc.</li>
</ul>
</li>
<li>
<pre tabindex="0"><code>2種類のサービス形態がある。
平たくまとめるとお金を取るか、取らないか。無料で利用できるのがOSS。
BigQueryは無料枠もあるが、処理に応じて従量課金型。
</code></pre></li>
</ul>
</li>
<li>
<p>SQLとは</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- {テーブル名}から、{カラム名}に記載の列を取得してきて！って意味
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="err">{カラム名}</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="err">{テーブル名}</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>SQL生みの親
<blockquote>
<p><img src="https://i.gyazo.com/98a9bea92ecc5c16284d732b6e14e958.png" alt="img"></p>
<p>SQL（Structured Query Language：構造化された検索言語）の略で、古くはIBM社が1970年台に開発していたデータベース管理システムの制御用の言語、SEQUEL（Structured English Query Language）が元になっている。</p>
<p>cf. <a href="https://slidetodoc.com/the-relational-model-content-based-on-chapter-3-2/">The Relational Model Content based on Chapter 3</a> SlideToDoc</p></blockquote>
</li>
<li>
<blockquote>
<p>SQLは、関係データベース管理システム において、データの操作や定義を行うためのデータベース言語、ドメイン固有言語である。プログラミングにおいてデータベースへのアクセスのために、他のプログラミング言語と併用される。</p>
<p>cf. <a href="https://ja.wikipedia.org/wiki/SQL">SQL</a> Wekipedia</p></blockquote>
</li>
</ul>
</li>
<li>
<p>Google BigQueryとは？</p>
<ul>
<li>-&gt; ざっくり、Googleが提供するPaaS（Platform as a Service）のこと。</li>
<li>
<blockquote>
<p>BigQuery（ビッグクエリ）は、ペタバイト単位のデータに対するスケーラブルな分析を可能にする、フルマネージドのサーバーレスのデータウェアハウスである。<a href="">ANSI SQL</a>を使用したクエリをサポートするPlatform as a Service（PaaS）としてGoogle Cloud Platformにより提供されている。また、機械学習の機能も組み込まれている。BigQueryは2010年5月に発表され、2011年11月に一般提供（GA）となった。</p>
<p>cf. <a href="https://ja.wikipedia.org/wiki/BigQuery">BigQuery</a> Wikipedia</p></blockquote>
</li>
<li>
<blockquote>
<p>適切なハードウェアとインフラストラクチャを用意せずに大規模なデータセットを保存し、それに対してクエリを実行すると、時間と費用がかかってしまいます。エンタープライズ データ ウェアハウスである Google BigQuery は、Google のインフラストラクチャの処理能力を活用して SQL クエリを<strong>超高速</strong>で実行し、こうした問題を解決します。データを BigQuery に読み込んだら、後の処理は Google にお任せください。また、データの<strong>表示</strong>やクエリの<strong>実行権限</strong>を自分以外のユーザーに付与できるため、業務上の必要に応じてプロジェクトや自分のデータに対するアクセスを制御することも可能です。</p>
<p>cf. <a href="https://cloud.google.com/bigquery/docs/introduction?hl=ja">BigQuery とは</a> GoogleCloud</p></blockquote>
</li>
</ul>
</li>
<li>
<p>BigQuery環境構築</p>
<ul>
<li><img src="https://i.gyazo.com/edac850c69d81a2eccfa28c349bd5e09.png" alt="project"></li>
</ul>
</li>
</ul>
<ol>
<li>BigQueryにアクセス
<ul>
<li><a href="https://cloud.google.com/bigquery/">https://cloud.google.com/bigquery/</a></li>
<li>完成イメージとしては以下のような図。</li>
<li><img src="https://i.gyazo.com/4ad2aaf572a3e100a4dc2aa008df32e4.png" alt="finaly">
<pre tabindex="0"><code>外枠にプロジェクトがあり、その中にデータセットがあり、更にその中に各テーブル（Excelでいうタブ）がある。
入れ子（ネスト）構造。
</code></pre></li>
</ul>
</li>
<li>プロジェクトを作成
<ul>
<li><img src="https://i.gyazo.com/98551e2f0aea93e9506d6d018c2ace9f.png" alt="make project"></li>
</ul>
</li>
<li>データセットを作成
<ul>
<li><img src="https://i.gyazo.com/592db3e492533ab6c672ee8ac172720a.png" alt="make_ds"></li>
</ul>
</li>
<li>テーブルを作成
<ul>
<li><img src="https://i.gyazo.com/a321a6ed34a70f197338198ec69ddcd5.png" alt="make_table"></li>
</ul>
</li>
</ol>

  <p></p>
</details>

<h4 id="section4--基本文法">SECTION4  ：基本文法<a class="anchor" aria-hidden="true" href="#section4--基本文法"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <ul>
<li>
<p>記述順序</p>
<pre tabindex="0"><code>1. SELECT      ：取得する列の指定
2.（集計関数）
3. FROM        ：取得するテーブルの指定
4. JOIN        ：テーブルの結合の処理
5. ON / USING  ：結合に利用するキー指定
6. WHERE       ：絞り込み条件の指定
7. GROUP BY    ：グループ化項目の指定
8. HAVING      ：グループ化された集計結果に対して絞り込み条件の指定
9. ORDER BY    ：並び替え条件
10. LIMIT      ：表示する行数の指定
</code></pre></li>
<li>
<p>実行順序</p>
<pre tabindex="0"><code>1. FROM
2. ON / USING
3. JOIN
4. WHERE
5. GROUP BY
6. (集計関数)
7. HAVING
8. SELECT
9. ORDER BY
10. LIMIT
</code></pre></li>
<li>
<p>SELECT句 - かラム指定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql:4.2_演習問題_1.sql" data-lang="sql:4.2_演習問題_1.sql"><span class="line"><span class="cl"><span class="c1">-- shop_purchasesテーブルからpurchase_id,user_id,dateを取り出してください。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">purchase_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |purchase_id|user_id|date      |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|         22| 956425|2018-01-05|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|        388| 937162|2018-04-30|
</span></span></span></code></pre></div></li>
<li>
<p>DISTINCT句 - 重複除外</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL:4.2_演習問題2.sql" data-lang="SQL:4.2_演習問題2.sql"><span class="line"><span class="cl"><span class="c1">-- shop_purchasesを利用して、固有のユーザーが何人いるかを取得。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1| 956425|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2| 937162|
</span></span></span></code></pre></div></li>
<li>
<p>EXCEPT() - かラム除外</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql:4.3_演習問題1.sql" data-lang="sql:4.3_演習問題1.sql"><span class="line"><span class="cl"><span class="c1">-- shop_purchasesテーブルから全カラムを取得。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="mi">70</span><span class="p">.</span><span class="mi">1</span><span class="n">KB</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql:4.3_演習問題2.sql" data-lang="sql:4.3_演習問題2.sql"><span class="line"><span class="cl"><span class="c1">-- shop_purchasesテーブルからshop_id、product_idを除くカラムを取得。
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ie. 抽出時に除外したいカラム名を記載。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="nf">EXCEPT</span><span class="p">(</span><span class="n">shop_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="mi">50</span><span class="p">.</span><span class="mi">1</span><span class="n">KB</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>ORDERBY句 - ソート機能
e.g.</p>
<pre tabindex="0"><code>ORDER BY {カラム番号,カラム} (ASC:昇順 DESC:降順） … [1]indexに注意
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL:4.4_演習問題1.sql" data-lang="SQL:4.4_演習問題1.sql"><span class="line"><span class="cl"><span class="c1">-- shop_purchasesテーブルから、user_id、quantityを取得し、
</span></span></span><span class="line"><span class="cl"><span class="c1">-- quantityの大きい順に並び替える。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ORDER BY 2 DESC;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | | user_id| quantity|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|  971235|        5|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|  992842|        5|
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL4.4_演習問題2.sql" data-lang="SQL4.4_演習問題2.sql"><span class="line"><span class="cl"><span class="c1">-- shop_purchasesテーブルの全列を取得し、dateの古い順(日付順)に並べる。
</span></span></span><span class="line"><span class="cl"><span class="c1">-- もし、同じ日に複数行ある場合、sales_amountの大きい順に並べる。
</span></span></span><span class="line"><span class="cl"><span class="c1">-- さらに、sales_amountも同額であった場合には、quantityの大きい順に並べる。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">--</span><span class="err">日付順</span><span class="p">(</span><span class="err">昇順</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="err">同日の場合売上高降順</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="err">数量降順</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--                        [ASC]                         [DESC]   [DESC]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |purchase_id|user_id|date      |shop_id|product_id|quantity|sales_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|          6| 954830|2018-01-01|      1|        17|       3|       15488|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|          1| 733995|2018-01-01|      2|        10|       1|       12775|
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL4.4:演習問題3.sql" data-lang="SQL4.4:演習問題3.sql"><span class="line"><span class="cl"><span class="c1">-- shop_purchasesテーブルの全列を取得し、dateの新しい順（日付逆順）に並べる。
</span></span></span><span class="line"><span class="cl"><span class="c1">-- もし、同日複数のレコードがある場合には、sales_amountの小さい順に並べる。
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 但、並べ替えには列の順序番号を利用すること。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="mi">7</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--                        [DESC]                                 [ASC]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |purchase_id|user_id|date      |shop_id|product_id|quantity|sales_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|       1281| 873505|2018-12-31|      2|         7|       1|        7527|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|       1280| 840135|2018-12-31|      1|        11|       2|        7527|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|       1282|1118265|2018-12-31|      1|        15|       4|       16000|
</span></span></span></code></pre></div></li>
<li>
<p>LIMIT句 - レコード制限</p>
<pre tabindex="0"><code>※ 表示レコード数を制限するだけで、後ろの計算は全行行われている。
  そのため発生料金に対して節約できるわけではない。
</code></pre><p>ex.【4.5 演習問題1 (0:55)】</p>
<p>shop_purchasesテーブルから、全カラムを5行だけ取得してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.5 演習問題2 (2:23)】</p>
<p>shop_purchasesテーブルから、date大きい順（＝新しい順）に、全カラムを10行だけ取得してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>OFFSET
e.g.</p>
</li>
</ul>
<pre tabindex="0"><code>LIMIT [取得したい行数] OFFSET [取得をずらす行数];
※ ORDERBY を使用前提
</code></pre><p>ex.【4.5 演習問題3 (:)】取得制限</p>
<p>shop_purchasesテーブルから、purchase_id、sales_amountを取得。その際sales_amont降順に並べた上で11位から5レコードだけを取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">purchase_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>行</th>
          <th style="text-align: right">purchase_id</th>
          <th style="text-align: right">sales_amont</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">233</td>
          <td style="text-align: right">73000</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: right">286</td>
          <td style="text-align: right">72568</td>
      </tr>
  </tbody>
</table>
<pre><code>※ 上位10行から、上位5行（＝5位）まで取得している
</code></pre>
<h3 id="-where句---絞り込み条件">| WHERE句 - 絞り込み条件<a class="anchor" aria-hidden="true" href="#-where句---絞り込み条件"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<p>shop_purchasesテーブルからquantity列の３より大きい行を取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s1">&#39;bq_sample.shop_purchases&#39;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><pre><code>※ WHERE句はFROM句の直後に記述する。
※ 絞り込みをしてもBigQueryの費用抑制にはならない。
</code></pre>
<h4 id="-数字型">■ 数字型<a class="anchor" aria-hidden="true" href="#-数字型"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<h5 id="-比較演算子">| 比較演算子<a class="anchor" aria-hidden="true" href="#-比較演算子"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>=</td>
          <td>同値</td>
      </tr>
      <tr>
          <td>!= , &lt;&gt;</td>
          <td>否定</td>
      </tr>
      <tr>
          <td>&gt; , &gt;=</td>
          <td>超える（大きい）、以上</td>
      </tr>
      <tr>
          <td>&lt; , &lt;=</td>
          <td>未満（小さい）、以下</td>
      </tr>
  </tbody>
</table>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- 売上高¥10,000以上のレコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">sales</span><span class="o">-</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 数量3以下のレコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span></code></pre></div><h5 id="-between句">| BETWEEN句<a class="anchor" aria-hidden="true" href="#-between句"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- ¥8,500~¥9,800に該当レコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">list_price</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">8500</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">9800</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ¥8,500~¥9,800に該当レコード以外
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">list_price</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">8500</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">9800</span><span class="w">
</span></span></span></code></pre></div><h5 id="-in句">| IN句<a class="anchor" aria-hidden="true" href="#-in句"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- 数量が「3」「7」「11」にに該当レコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 数量が「3」「7」「11」にに該当レコード以外
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.7 演習問題1(3:11)】</p>
<p>shop_purchasesテーブルから、quantityが3以上のuser_idをレコード単位で取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>行</th>
          <th style="text-align: right">user_id</th>
          <th style="text-align: right">quantity</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">956425</td>
          <td style="text-align: right">3</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: right">937162</td>
          <td style="text-align: right">3</td>
      </tr>
  </tbody>
</table>
<p>ex.【4.7 演習問題2(7:15)】</p>
<p>shop_purchasesテーブルから、user_id、sales_amont列を取得。但、sales_amontが5000~10000の間のレコードだけを取得対象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex. 【4.7 演習問題3(8:15)】</p>
<p>shop_purchasesテーブルから、user_id、date、sales_amont、shop_id列を取得。
但、shop_idが１、３、４のいずれかのレコードだけを対象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">shop_id</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h4 id="-文字型">■ 文字型<a class="anchor" aria-hidden="true" href="#-文字型"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">--名前が鈴木のレコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;鈴木&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--名前が田中でないレコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&#34;田中&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--名前が山田、鈴木、田中のレコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">WEHER</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="s2">&#34;山田&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;鈴木&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;田中&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--名前が山田、鈴木、田中でないレコード
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">WEHER</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="s2">&#34;山田&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;鈴木&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;田中&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h5 id="-like句">| LIKE句<a class="anchor" aria-hidden="true" href="#-like句"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">--名前が「美○」の後方一致レコード eg.美咲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;美%&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--名前が「○美」の後方一致レコード eg.愛佑美
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;%美&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--名前が「○美○」の部分一致レコード eg.美咲,愛佑美
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;%美%&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 名前が「(2文字)子」のレコード eg.由香子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;__子&#34;</span><span class="w">
</span></span></span></code></pre></div><pre><code>※ % :任意の文字数
※ _ :一文字
</code></pre>
<p>ex.【4.8 演習問題1(3:22)】</p>
<p>customersテーブルから、last_nameが&quot;前田&quot;に一致するレコードを全カラム取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;前田&#34;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.8 演習問題2(4:15)】</p>
<p>customersテーブルから、first_nameが&quot;愛&quot;、&ldquo;愛子&rdquo;、&ldquo;愛美&quot;に一致するレコードを全カラム取得してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s2">&#34;愛&#34;</span><span class="p">,</span><span class="s2">&#34;愛子&#34;</span><span class="p">,</span><span class="s2">&#34;愛美&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.8 演習問題3(5:15)】</p>
<p>customersテーブルから、first_nameが&quot;子&quot;で終わらないレコードを全カラム取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;%子&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="-日付型">■ 日付型<a class="anchor" aria-hidden="true" href="#-日付型"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s2">&#34;2017-01-01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&#34;2017-01-01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="s2">&#34;2017-07-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2017-07-02&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2017-07-01 00:09:00&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2017-07-01 18:00:00&#34;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.9 演習問題1(2:00)】</p>
<p>shop_purchasesテーブルから、dateが2018年6月1日より前のレコードを全カラム取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="s2">&#34;2018-06-01&#34;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.9 演習問題1(5:00)】</p>
<p>shop_purchasesテーブルから、dateが2018年4月29日から2018年5月6日の間にないレコード全カラム取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-04-29&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-05-06&#34;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="-論理型">■ 論理型<a class="anchor" aria-hidden="true" href="#-論理型"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">WHERE</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">TRUE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">TRUE</span><span class="w">  </span><span class="c1">-- False
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">FALSE</span><span class="w"> </span><span class="c1">-- True
</span></span></span></code></pre></div><p>ex.【4.10 演習問題1(1:20)】</p>
<p>customersテーブルからuser_id、last_nameを取得。但、is_premiumがfalseのレコードのみ取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="-where句---複数条件論理演算子">| WHERE句 - 複数条件（論理演算子）<a class="anchor" aria-hidden="true" href="#-where句---複数条件論理演算子"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- AND条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">TRUE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">TRUE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">prefecture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;北海道&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- (AND条件)＋OR条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">TRUE</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">prefecture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;北海道&#34;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.11 演習問題1(3:20)】</p>
<p>customersテーブルからuser_id、last_name、first_nameを取得。
但、「is_premiumがfalseで、genderが1」もしくは「birthdayが1970年12月31日以前」のレコードのみを取得。user_idの昇順に５レコード表示。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="n">is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">OR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">birthday</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s2">&#34;1970-12-31&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="-where句---nullの振る舞い">| WHERE句 - NULLの振る舞い<a class="anchor" aria-hidden="true" href="#-where句---nullの振る舞い"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- genderが2でbirthdayがnull値でない条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">birthday</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.12 演習問題1(2:00)】</p>
<p>customersテーブルからuser_id last_name first_nameを取得。但、first_nameがnullい該当レコードだけを取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="-as句---かラム名上書き">| AS句 - かラム名上書き<a class="anchor" aria-hidden="true" href="#-as句---かラム名上書き"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="c1">--dateを何の日かを説明補完できる（日 as 購入日）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">       </span><span class="nb">date</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">purchase_data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><pre tabindex="0"><code>（メモ）
・AS句は、「AS」と記載しなくとも半角スペースでも同様の挙動となる。
  可読性の観点から、明記した方が親切。
・半角英数（大文字、小文字）とアンダーバー（_）使用可能。
・スペース、日本語は使用不可。
</code></pre><p>ex.【4.13 演習問題1(1:50)】</p>
<p>shop_purchasesテーブルからuser_id sales_amontを取得。
sales_amontはsales_in_JPYという列名で表示。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salse_in_JPY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.13 演習問題2(3:00)】</p>
<p>shop_purchasesテーブルからuser_id sales_amontを取得。
sales_amontはsales_in_JPYという列名で、更に降順で５レコード表示。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salse_in_JPY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salse_in_JPY</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【4.13 演習問題2(5:00)】</p>
<p>(エラーを確認しよう。)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salse_in_JPY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">salse_in_JPY</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="c1">--error. Unrecognized name: salse_in_JPY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salse_in_JPY</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><pre tabindex="0"><code>（メモ）
WHERE句の中ではAS句で指定したカラム名は使用できない。
∵ 実行順序の関係によるため。(Cf. 5.10)
</code></pre>
  <p></p>
</details>

<h4 id="section5--集計関数">SECTION5  ：集計関数<a class="anchor" aria-hidden="true" href="#section5--集計関数"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <h3 id="-count---行数集計">| COUNT(*) - 行数集計<a class="anchor" aria-hidden="true" href="#-count---行数集計"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*「個数が１のレコード数をカウントしたい」
</span></span></span><span class="line"><span class="cl"><span class="cm">※行数のカウントであってデータ個数ではない*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">No_of_record</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【5.2 演習問題1(2:09)】</p>
<p>customersテーブルから、gender=2、かつ、birthdayが1989年1月8日以降のレコード数を取得（平成生まれの女性の顧客数）。列名gyou_suとする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">gyou_su</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">birthday</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s2">&#34;1989-01-08&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |gyou_su|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1||
</span></span></span></code></pre></div><h3 id="-countcolumn---データ個数集計">| COUNT(column) - データ個数集計<a class="anchor" aria-hidden="true" href="#-countcolumn---データ個数集計"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="err">かラム名</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*「会員の名前を重複なく取得」カテゴリカル変数の分類集計*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">DISTONCT</span><span class="w"> </span><span class="n">first_name</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>ex.【5.2 演習問題2(6:50)】</p>
<p>customersテーブルから、女性の行数、女性のfirst_nameの個数、女性のfirst_nameの種類数を取得。列名は其々、gyou_su、data_kosu、shurui_su。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">gyou_su</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">first_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">data_kosu</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">first_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">shurui_su</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |gyou_su|data_kosu|shurui_su|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|    592|      588|      565|
</span></span></span></code></pre></div><h3 id="-groupby句---グループ化">| GROUPBY句 - グループ化<a class="anchor" aria-hidden="true" href="#-groupby句---グループ化"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre tabindex="0"><code>データから意味を読み取るには。
  「質的データ（定性）」項目でグループを作る。
  「量的データ（定量）」を集計する。
</code></pre><p>e.g. 店舗ID別のレコード数が知りたい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">No_of_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-01-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-06-30&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w"> </span><span class="c1">--店舗IDでまとめる (※SELECTに書いてないかラム名だとerror)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">shop_id</th>
          <th style="text-align: right">No_of_purchase</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">1</td>
          <td style="text-align: right">265</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: right">2</td>
          <td style="text-align: right">207</td>
      </tr>
      <tr>
          <td>3</td>
          <td style="text-align: right">3</td>
          <td style="text-align: right">87</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.4 演習問題1(3:30)】</p>
<p>shop_purchasesテーブルから、product_idごとの販売件数（＝レコード数）を取得。
販売件数はNo_of_purchaseと別名にする。出力はNo_of_purchase降順。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">No_of_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">NO_of_purchase</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |product_id|No_of_purchase|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|        11|           102|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|        10|            98|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|        13|            93|
</span></span></span></code></pre></div><p>ex.【5.4 演習問題2(6:20)】</p>
<p>customersテーブルから、prefectureごとの会員数を求める。結果は会員数の多い順に並べ替える。ただし、ORDERBY、GROUPBY何も列番号指定で記述。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prefecture</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">no_of_menbers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |prefecture|no_of_menbers|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|Tokyo     |          582|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|Osaka     |           88|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|Kanagawa  |           72|
</span></span></span></code></pre></div><p>ex.【5.4 演習問題3(8:00)】</p>
<p>shop_purchasesテーブルで、第一項目をshop_id第二項目をproduct_idとしてグループ化した販売件数（＝レコード数）をまとめ、shop_idの昇順、product_idの昇順の優先順位でソートして出力する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT shop_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--        COUNT(shop_id) AS No_of_purchases_by_shop,
</span></span></span><span class="line"><span class="cl"><span class="c1">--        COUNT(product_id) AS No_of_purchases_by_product
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_sample.shop_purchases`
</span></span></span><span class="line"><span class="cl"><span class="c1">-- GROUP BY shop_id
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ORDER BY 2 &gt;= 3;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">NO_of_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|product_id|No_of_purchase|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|         1|            17|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      1|         2|            17|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|      1|         3|            10|
</span></span></span></code></pre></div><pre tabindex="0"><code>（重要）
グルーピングにはSELECT内に記載した順番が問われる。
∴ GROPBYの順番を変更したとしても問題はない。
</code></pre><h3 id="-sum---合計値">| SUM() - 合計値<a class="anchor" aria-hidden="true" href="#-sum---合計値"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">f0_</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2895</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.5 演習問題1(1:56)】</p>
<p>shop_id別のquantityの合計値を取得。
quantityの合計の列名を、Total_quantityとする。Total_quantityの降順。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Total_quantity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|Taotal_quantity|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|           1257|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|           1063|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|      3|            460|
</span></span></span></code></pre></div><p>ex.【5.5 演習問題2(3:30)】</p>
<p>shop_id別のsales_amountの合計を取得。
sales_amountの合計の列名をTotal_salesとする。Total_sales多い順。
但、product_idが1,5,11,18に該当するレコードだけを対象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Total_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Total_sales</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|Total_salse|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|    1789674|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|    1422230|
</span></span></span></code></pre></div><p>eg .※ <code>SUM()</code> 集計時はNULLが無視される。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">ttl_qty</th>
          <th style="text-align: right">ttl_salse</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">9</td>
          <td style="text-align: right">49600</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: left">shop_name</th>
          <th style="text-align: right">ttl_qty</th>
          <th style="text-align: right">ttl_salse</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: left">新宿</td>
          <td style="text-align: right">5</td>
          <td style="text-align: right">27800</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: left">渋谷</td>
          <td style="text-align: right">4</td>
          <td style="text-align: right">21800</td>
      </tr>
  </tbody>
</table>
<h3 id="-avg---平均値">| AVG() - 平均値<a class="anchor" aria-hidden="true" href="#-avg---平均値"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">f0_</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2.258190327613107</td>
      </tr>
  </tbody>
</table>
<p>eg. ※ <code>AVG()</code> の集計時のNULLの振る舞い(計算時は無視される)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_qty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">avg_qty</th>
          <th style="text-align: right">avg_salse</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2.25</td>
          <td style="text-align: right">12400.0</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.6 演習問題1(2:30)】</p>
<p>shop_id別のquantityの平均を取得。
quantity平均の列名を、avg_atyとして、大きい順に並べ替える。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|avg_qty           |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      5|               3.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      3|2.4468085106382977|
</span></span></span></code></pre></div><p>ex.【5.6 演習問題2(3:30)】</p>
<p>shop_id別のsales_amountの平均を取得。
sales_amount平均の列名を、avg_salesとして、大きい順に並べ替える。
但、dateが2018年6月に一致するレコードを対象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-06-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-06-30&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|avg_sales        |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|17558.62222222221|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|12881.13043478261|
</span></span></span></code></pre></div><h3 id="-max-min---最大値最小値">| MAX(), MIN() - 最大値、最小値<a class="anchor" aria-hidden="true" href="#-max-min---最大値最小値"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">max</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">min</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">max</th>
          <th style="text-align: right">min</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">99000</td>
          <td style="text-align: right">1400</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.7 演習問題1(1:15)】</p>
<p>shop_id毎のproduct_idが15番の商品の1回の販売での最高額を調査。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|max_sales|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|    19300|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|    20000|
</span></span></span></code></pre></div><p>ex.【5.7 演習問題2(3:15)】</p>
<p>product_idが4番の商品を、一回の販売で1個だけ販売した際に最も低い額で販売した日を、shop_idを調査。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="k">AS</span><span class="w"> </span><span class="n">min_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |date      |shop_id|min_salse|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|2018-06-30|      3|    13260|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|2018-01-21|      3|    13650|
</span></span></span></code></pre></div><h3 id="-標準偏差standard-deviation">| 標準偏差（=standard deviation）<a class="anchor" aria-hidden="true" href="#-標準偏差standard-deviation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre><code>分析対象が母集団（= population）：STDDEV_POP(カラム名)
分析対象が標本（＝sample）      ：STDDEV_SAMP(カラム名)
</code></pre>
<p>ex.【5.8 演習問題1(2:35)】</p>
<p>shop_purchasesテーブルを用いて、店舗毎の１販売あたりの金額のばらつきの大きさをproduct_idが15番の商品について調べる。
指標は、母標準偏差を使用して、std_salesという列名で表示する。ばらつきが小さい順。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">std_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|std_sales         |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      4|3664.3411301852543|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      1| 4962.301658504852|
</span></span></span></code></pre></div><h3 id="-having句---集計結果にフィルタリング">| HAVING句 - 集計結果にフィルタリング<a class="anchor" aria-hidden="true" href="#-having句---集計結果にフィルタリング"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sum_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="w">  </span><span class="c1">--ココ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sum_qty</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">shop_id</th>
          <th style="text-align: right">sum_qty</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2</td>
          <td style="text-align: right">1257</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: right">1</td>
          <td style="text-align: right">1063</td>
      </tr>
  </tbody>
</table>
<pre><code>※ WHERE句とHAAVING句の違い
    ・WHERE句は、集計前に実行（絞り込み）される。
    ・HAVING句は、集計後の結果に対して実行される。
   似ているが混同しないように！

# eg. WHEREで同様な絞り込みをかけると、エラーが返る。
#      WHERE SUM(quantity) &gt; 1000
#     (error) Aggregate function SUM not allowed in WHERE clause
</code></pre>
<p>ex.【5.9 演習問題1(4:30)】</p>
<p>product_idが18番の商品について、店舗毎の平均売上金額を取得。
また、平均売上金額15,000円を超える店舗だけを表示。
さらに、平均売上金額が大きい順にする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="n">avg_salse</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">15000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">avg_salse</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|avg_slse          |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      4|           25090.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      2|16971.185185185186|
</span></span></span></code></pre></div><p>ex.【5.9 演習問題2(10:45)】</p>
<p>customersテーブルに対し、prefecture毎のプレミアムユーザー数（プレミアムユーザーは、Is_premiumの値がtrue）を取得。
プレミアムユーザー数が15人以下のprefectureを、プレミアムユーザー数の多い順に並べ替え。
但、絞り込みにも、並べ替えにも列の別名を利用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prefecture</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pref</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Is_premium</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prefecture</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pref</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |prefecture|users|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|Osaka     |   11|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|Kanagawa  |   11|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|Saitama   |    4|
</span></span></span></code></pre></div>
  <p></p>
</details>

<h4 id="section6--四則演算条件分岐">SECTION6  ：四則演算、条件分岐<a class="anchor" aria-hidden="true" href="#section6--四則演算条件分岐"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <h3 id="-count---行数集計">| COUNT(*) - 行数集計<a class="anchor" aria-hidden="true" href="#-count---行数集計"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*「個数が１のレコード数をカウントしたい」
</span></span></span><span class="line"><span class="cl"><span class="cm">※行数のカウントであってデータ個数ではない*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">No_of_record</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ex.【5.2 演習問題1(2:09)】</p>
<p>customersテーブルから、gender=2、かつ、birthdayが1989年1月8日以降のレコード数を取得（平成生まれの女性の顧客数）。列名gyou_suとする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">gyou_su</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">birthday</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s2">&#34;1989-01-08&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |gyou_su|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1||
</span></span></span></code></pre></div><h3 id="-countcolumn---データ個数集計">| COUNT(column) - データ個数集計<a class="anchor" aria-hidden="true" href="#-countcolumn---データ個数集計"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="err">かラム名</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*「会員の名前を重複なく取得」カテゴリカル変数の分類集計*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">DISTONCT</span><span class="w"> </span><span class="n">first_name</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>ex.【5.2 演習問題2(6:50)】</p>
<p>customersテーブルから、女性の行数、女性のfirst_nameの個数、女性のfirst_nameの種類数を取得。列名は其々、gyou_su、data_kosu、shurui_su。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">gyou_su</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">first_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">data_kosu</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">first_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">shurui_su</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |gyou_su|data_kosu|shurui_su|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|    592|      588|      565|
</span></span></span></code></pre></div><h3 id="-groupby句---グループ化">| GROUPBY句 - グループ化<a class="anchor" aria-hidden="true" href="#-groupby句---グループ化"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre tabindex="0"><code>データから意味を読み取るには。
  「質的データ（定性）」項目でグループを作る。
  「量的データ（定量）」を集計する。
</code></pre><p>e.g. 店舗ID別のレコード数が知りたい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">No_of_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-01-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-06-30&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w"> </span><span class="c1">--店舗IDでまとめる (※SELECTに書いてないかラム名だとerror)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">shop_id</th>
          <th style="text-align: right">No_of_purchase</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">1</td>
          <td style="text-align: right">265</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: right">2</td>
          <td style="text-align: right">207</td>
      </tr>
      <tr>
          <td>3</td>
          <td style="text-align: right">3</td>
          <td style="text-align: right">87</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.4 演習問題1(3:30)】</p>
<p>shop_purchasesテーブルから、product_idごとの販売件数（＝レコード数）を取得。
販売件数はNo_of_purchaseと別名にする。出力はNo_of_purchase降順。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">No_of_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">NO_of_purchase</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |product_id|No_of_purchase|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|        11|           102|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|        10|            98|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|        13|            93|
</span></span></span></code></pre></div><p>ex.【5.4 演習問題2(6:20)】</p>
<p>customersテーブルから、prefectureごとの会員数を求める。結果は会員数の多い順に並べ替える。ただし、ORDERBY、GROUPBY何も列番号指定で記述。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prefecture</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">no_of_menbers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |prefecture|no_of_menbers|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|Tokyo     |          582|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|Osaka     |           88|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|Kanagawa  |           72|
</span></span></span></code></pre></div><p>ex.【5.4 演習問題3(8:00)】</p>
<p>shop_purchasesテーブルで、第一項目をshop_id第二項目をproduct_idとしてグループ化した販売件数（＝レコード数）をまとめ、shop_idの昇順、product_idの昇順の優先順位でソートして出力する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT shop_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--        COUNT(shop_id) AS No_of_purchases_by_shop,
</span></span></span><span class="line"><span class="cl"><span class="c1">--        COUNT(product_id) AS No_of_purchases_by_product
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_sample.shop_purchases`
</span></span></span><span class="line"><span class="cl"><span class="c1">-- GROUP BY shop_id
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ORDER BY 2 &gt;= 3;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">NO_of_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|product_id|No_of_purchase|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|         1|            17|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      1|         2|            17|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|      1|         3|            10|
</span></span></span></code></pre></div><pre tabindex="0"><code>（重要）
グルーピングにはSELECT内に記載した順番が問われる。
∴ GROPBYの順番を変更したとしても問題はない。
</code></pre><h3 id="-sum---合計値">| SUM() - 合計値<a class="anchor" aria-hidden="true" href="#-sum---合計値"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">f0_</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2895</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.5 演習問題1(1:56)】</p>
<p>shop_id別のquantityの合計値を取得。
quantityの合計の列名を、Total_quantityとする。Total_quantityの降順。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Total_quantity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|Taotal_quantity|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|           1257|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|           1063|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|      3|            460|
</span></span></span></code></pre></div><p>ex.【5.5 演習問題2(3:30)】</p>
<p>shop_id別のsales_amountの合計を取得。
sales_amountの合計の列名をTotal_salesとする。Total_sales多い順。
但、product_idが1,5,11,18に該当するレコードだけを対象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Total_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Total_sales</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|Total_salse|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|    1789674|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|    1422230|
</span></span></span></code></pre></div><p>eg .※ <code>SUM()</code> 集計時はNULLが無視される。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">ttl_qty</th>
          <th style="text-align: right">ttl_salse</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">9</td>
          <td style="text-align: right">49600</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: left">shop_name</th>
          <th style="text-align: right">ttl_qty</th>
          <th style="text-align: right">ttl_salse</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: left">新宿</td>
          <td style="text-align: right">5</td>
          <td style="text-align: right">27800</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: left">渋谷</td>
          <td style="text-align: right">4</td>
          <td style="text-align: right">21800</td>
      </tr>
  </tbody>
</table>
<h3 id="-avg---平均値">| AVG() - 平均値<a class="anchor" aria-hidden="true" href="#-avg---平均値"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">f0_</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2.258190327613107</td>
      </tr>
  </tbody>
</table>
<p>eg. ※ <code>AVG()</code> の集計時のNULLの振る舞い(計算時は無視される)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_qty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">null_treatment</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">avg_qty</th>
          <th style="text-align: right">avg_salse</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2.25</td>
          <td style="text-align: right">12400.0</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.6 演習問題1(2:30)】</p>
<p>shop_id別のquantityの平均を取得。
quantity平均の列名を、avg_atyとして、大きい順に並べ替える。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|avg_qty           |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      5|               3.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      3|2.4468085106382977|
</span></span></span></code></pre></div><p>ex.【5.6 演習問題2(3:30)】</p>
<p>shop_id別のsales_amountの平均を取得。
sales_amount平均の列名を、avg_salesとして、大きい順に並べ替える。
但、dateが2018年6月に一致するレコードを対象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-06-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-06-30&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|avg_sales        |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|17558.62222222221|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|12881.13043478261|
</span></span></span></code></pre></div><h3 id="-max-min---最大値最小値">| MAX(), MIN() - 最大値、最小値<a class="anchor" aria-hidden="true" href="#-max-min---最大値最小値"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">max</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">min</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">max</th>
          <th style="text-align: right">min</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">99000</td>
          <td style="text-align: right">1400</td>
      </tr>
  </tbody>
</table>
<p>ex.【5.7 演習問題1(1:15)】</p>
<p>shop_id毎のproduct_idが15番の商品の1回の販売での最高額を調査。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|max_sales|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      1|    19300|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      2|    20000|
</span></span></span></code></pre></div><p>ex.【5.7 演習問題2(3:15)】</p>
<p>product_idが4番の商品を、一回の販売で1個だけ販売した際に最も低い額で販売した日を、shop_idを調査。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="k">AS</span><span class="w"> </span><span class="n">min_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |date      |shop_id|min_salse|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|2018-06-30|      3|    13260|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|2018-01-21|      3|    13650|
</span></span></span></code></pre></div><h3 id="-標準偏差standard-deviation">| 標準偏差（=standard deviation）<a class="anchor" aria-hidden="true" href="#-標準偏差standard-deviation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre><code>分析対象が母集団（= population）：STDDEV_POP(カラム名)
分析対象が標本（＝sample）      ：STDDEV_SAMP(カラム名)
</code></pre>
<p>ex.【5.8 演習問題1(2:35)】</p>
<p>shop_purchasesテーブルを用いて、店舗毎の１販売あたりの金額のばらつきの大きさをproduct_idが15番の商品について調べる。
指標は、母標準偏差を使用して、std_salesという列名で表示する。ばらつきが小さい順。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">std_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|std_sales         |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      4|3664.3411301852543|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      1| 4962.301658504852|
</span></span></span></code></pre></div><h3 id="-having句---集計結果にフィルタリング">| HAVING句 - 集計結果にフィルタリング<a class="anchor" aria-hidden="true" href="#-having句---集計結果にフィルタリング"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sum_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="w">  </span><span class="c1">--ココ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sum_qty</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: right">shop_id</th>
          <th style="text-align: right">sum_qty</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td style="text-align: right">2</td>
          <td style="text-align: right">1257</td>
      </tr>
      <tr>
          <td>2</td>
          <td style="text-align: right">1</td>
          <td style="text-align: right">1063</td>
      </tr>
  </tbody>
</table>
<pre><code>※ WHERE句とHAAVING句の違い
    ・WHERE句は、集計前に実行（絞り込み）される。
    ・HAVING句は、集計後の結果に対して実行される。
   似ているが混同しないように！

# eg. WHEREで同様な絞り込みをかけると、エラーが返る。
#      WHERE SUM(quantity) &gt; 1000
#     (error) Aggregate function SUM not allowed in WHERE clause
</code></pre>
<p>ex.【5.9 演習問題1(4:30)】</p>
<p>product_idが18番の商品について、店舗毎の平均売上金額を取得。
また、平均売上金額15,000円を超える店舗だけを表示。
さらに、平均売上金額が大きい順にする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="n">avg_salse</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">15000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">avg_salse</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|avg_slse          |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      4|           25090.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      2|16971.185185185186|
</span></span></span></code></pre></div><p>ex.【5.9 演習問題2(10:45)】</p>
<p>customersテーブルに対し、prefecture毎のプレミアムユーザー数（プレミアムユーザーは、Is_premiumの値がtrue）を取得。
プレミアムユーザー数が15人以下のprefectureを、プレミアムユーザー数の多い順に並べ替え。
但、絞り込みにも、並べ替えにも列の別名を利用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prefecture</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pref</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Is_premium</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prefecture</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pref</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |prefecture|users|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|Osaka     |   11|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|Kanagawa  |   11|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|Saitama   |    4|
</span></span></span></code></pre></div>
  <p></p>
</details>

<h4 id="section7--分析関数">SECTION7  ：分析関数<a class="anchor" aria-hidden="true" href="#section7--分析関数"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <h3 id="-分析関数ウィンドウ関数">| 分析関数(ウィンドウ関数)<a class="anchor" aria-hidden="true" href="#-分析関数ウィンドウ関数"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>分析関数（ウィンドウ関数）とは、行レベル関数、集計関数よりも、複雑で高度な計算ができる関数の種類。
「番号付け関数」「ナビゲーション関数」「集計関数」の3つに大別することができる。</p>
<p>どんな時に使うの？</p>
<pre><code>・店舗ごとに販売されたそれぞれの商品が、売上順で何位にランキングされるか求めたい。
・Webアクセスログから、ランディングページ毎のセッション数を求めたり、セッション開始時刻を終了時刻の差分からセッション時間を求め流ような場合。
</code></pre>
<h3 id="-over句---分析関数の書式">| OVER句 - 分析関数の書式<a class="anchor" aria-hidden="true" href="#-over句---分析関数の書式"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>※ SQLでの分析において最も重要な句。内側で3つの<code> (option)</code>がある。
ウィンドウ関数は、数式やWHERE句で用いることができない。
これは、ウィンドウ関数がWHERE句やGROUPBY句などの処理が終わった結果に対して作用する為。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="p">[</span><span class="err">関数</span><span class="p">]()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">option</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{分析を行うグループを作る対象のカラム名}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">option</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{パーテション中での並べ替えを行うカラム名}</span><span class="w"> </span><span class="k">ASC</span><span class="o">|</span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">option</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="n">WINDOW_FRAME</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">別名</span><span class="w">
</span></span></span></code></pre></div><p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">--PARTITION BY句： user_id別にまとめる
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">--ORDER BY句：patation内でquantityが多い順
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">--WINDOW_FRAME句: 境界の最上の値から現在の行まで
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cumlative_quantity_till_the_row</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--                      〈desc〉
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |user_id|order_id|quantity|cumlative_quantity_till_the_row| --境界の無い当該行までの累計数量取得
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |       9|      12|                             12|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |       1|      10|                             22|←(12+10)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|ABC    |       3|       8|                             30|←(12+10+8)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|ABC    |      10|       6|                             36|←(12+10+8+6)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|ABC    |       2|       5|                             41|←(12+10+8+6+5)
</span></span></span><span class="line"><span class="cl"><span class="c1">---------------------------------------------------------------------〈patition〉
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|STU    |      12|      12|                             12|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |7|STU    |       4|       8|                             20|←(12+8)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |8|STU    |      11|       3|                             23|←(12+8+3)
</span></span></span><span class="line"><span class="cl"><span class="c1">---------------------------------------------------------------------〈patition〉
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |9|www    |       5|       5|                              5|
</span></span></span></code></pre></div><h3 id="-option1-partition-by句">| (option.1) PARTITION BY句<a class="anchor" aria-hidden="true" href="#-option1-partition-by句"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>SELECT句における、GROUPBYのようにグループ分けを行う。
GRUOPBY句に似ているが、PARTITIONBY句では行の「集約」は行われない。</p>
<p>PARTIONによって分割されたまとまりを其々ウィンドウと呼ぶ。</p>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item_category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_category</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sum_category</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item_purchase_log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>item_name</th>
          <th>item_category</th>
          <th style="text-align: right">price</th>
          <th style="text-align: right">sum_category</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>コーヒー</td>
          <td>beverrage</td>
          <td style="text-align: right">280</td>
          <td style="text-align: right">1780</td>
      </tr>
      <tr>
          <td>コーヒー</td>
          <td>beverrage</td>
          <td style="text-align: right">750</td>
          <td style="text-align: right">1780</td>
      </tr>
      <tr>
          <td>コーヒー</td>
          <td>beverrage</td>
          <td style="text-align: right">750</td>
          <td style="text-align: right">1780</td>
      </tr>
      <tr>
          <td>紅茶</td>
          <td>food</td>
          <td style="text-align: right">280</td>
          <td style="text-align: right">1860</td>
      </tr>
      <tr>
          <td>緑茶</td>
          <td>food</td>
          <td style="text-align: right">200</td>
          <td style="text-align: right">1860</td>
      </tr>
      <tr>
          <td>砂糖</td>
          <td>food</td>
          <td style="text-align: right">200</td>
          <td style="text-align: right">1860</td>
      </tr>
      <tr>
          <td>メイプル</td>
          <td>food</td>
          <td style="text-align: right">450</td>
          <td style="text-align: right">1860</td>
      </tr>
      <tr>
          <td>メイプル</td>
          <td>food</td>
          <td style="text-align: right">450</td>
          <td style="text-align: right">1860</td>
      </tr>
      <tr>
          <td>砂糖</td>
          <td>food</td>
          <td style="text-align: right">280</td>
          <td style="text-align: right">1860</td>
      </tr>
  </tbody>
</table>
<h3 id="-option2-order-by句">| (option.2) ORDER BY句<a class="anchor" aria-hidden="true" href="#-option2-order-by句"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>(割愛)</p>
<h3 id="-option3-window-frame句">| (option.3) WINDOW FRAME句<a class="anchor" aria-hidden="true" href="#-option3-window-frame句"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="err">{</span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="err">}</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="err">{</span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ※ 未指定の場合上記がデフォで入る。
</span></span></span></code></pre></div><pre tabindex="0"><code>※ BETWEEN句の始値、終値には様々な指定ができる。
   CURRENT ROW         : 現在の行
   UNBOUNDED PRECEDING : パーテションで定義された境界の、最も上の方
   UNBOUNDED FOLLOWING : パーテションで定義された境界の、最も下の方
   [int] PRECEDING     : 現在の行から[int]だけ上の行
   [int] FOLLOWING     : 現在の行から[int]だけ下の行
</code></pre><p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- パーティション全体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">FOLLOWING</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- パーティションの最上部から現在の行まで。（sumと併用すると、累計を取得可）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 現在行を含む、直上７レコード。（ORDERBYを日付順にし、avg併用すると直近7日間の移動平均が取得可能）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="w">
</span></span></span></code></pre></div><p>※ ROWS以外の指定もできる。(本コースでは扱わないとのこと)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="err">{</span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="err">}</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="err">{</span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="err">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="-関数">| [関数]（）<a class="anchor" aria-hidden="true" href="#-関数"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<h4 id="--番号付け-関数">■  番号付け [関数]（）<a class="anchor" aria-hidden="true" href="#--番号付け-関数"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>使える<code>option</code>:</p>
<pre tabindex="0"><code>① PARTITIONBY  [使用可]
② ORDERBY      [必須]
③ WINDOWFRAME  [使用不可]
</code></pre><p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item_category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ranking</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DENSE_RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dense_ranking</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">row_num</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item_purchase_log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |item_name|item_category|price|ranking|dense_ranking|row_num|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|緑茶     |food         |  200|      1|            1|      1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|砂糖     |food         |  200|      1|            1|      2|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|コーヒー |beverrage    |  280|      3|            2|      3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|緑茶     |food         |  280|      3|            2|      4|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|砂糖     |food         |  200|      3|            2|      5|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|メイプル |food         |  450|      6|            3|      6|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |7|メイプル |food         |  450|      6|            3|      7|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |8|コーヒー |beverrage    |  750|      8|            4|      8
</span></span></span></code></pre></div><p>※ 番号付け関数には様々用意されている。</p>
<pre tabindex="0"><code>▷RANK()        : パーテションの中の順位を返す（同率は飛ばす）
  DENSE_RANK()  : パーテションの中の順位を返す（同率は飛ばさない）
  PERCENT_RANK():
▷ROW_NUMBER()  : パーテションの中の行数を返す
  CUME_DIST()   :
  NTILE()       :
</code></pre><h5 id="-rank---ランキング">| RANK() - ランキング<a class="anchor" aria-hidden="true" href="#-rank---ランキング"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">PARTION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">hoge</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">fuga</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">{</span><span class="n">hage</span><span class="err">}</span><span class="w">
</span></span></span></code></pre></div><p>ex.【7.4 演習問題1(2:20)】</p>
<p>trialデータセットのposテーブルに対し、パーティションを宣言しないで、order_id、user_id、qquantity及び、qunantity降順に基づくランクを取得。ランキングは昇順に並べ替えた結果を返す。（ランキングを表示するカラムは別名でrankを付与）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |order_id|user_id|quantity|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      12|STU    |      12|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|       9|ABC    |      12|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|       1|ABC    |      10|   3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|       4|STU    |       8|   4|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|       3|ABC    |       8|   4|
</span></span></span></code></pre></div><p>ex.【7.4 演習問題2(4:20)】</p>
<p>trialデータセットのposテーブルに対し、user_id別にquantityの多い順にランク値を取得。
並べ替えは、user_id、ランク値の順にどちらも昇順で行う。取得カラムはorder_id、user_id、quantityランク値（別名をrankとする）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--                       [desc]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |order_id|user_id|quantity|ranking|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|       9|ABC    |      12|      1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|       1|ABC    |      10|      2|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|       3|ABC    |       8|      3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|      10|ABC    |       6|      4|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|       2|ABC    |       5|      5|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -------------------------------------- [partitin]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|      12|STU    |      12|      1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |7|       4|STU    |       8|      2|
</span></span></span></code></pre></div><p>ex.【7.4 演習問題3(6:20)】</p>
<p>更に、rankが3位以内という絞り込みを行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ∴WHERE句は使用不可（分析関数では絞り込みできない）
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ∵WHEREが先に実行され、その後にSELECTの為
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (解決)サブクエリを用いる
</span></span></span></code></pre></div><h5 id="-row_number---パーテションの中の行番号を返す">| ROW_NUMBER() - パーテションの中の行番号を返す。<a class="anchor" aria-hidden="true" href="#-row_number---パーテションの中の行番号を返す"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">hoge</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">fuga</span><span class="err">}</span><span class="w"> </span><span class="k">ASC</span><span class="o">|</span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">{</span><span class="n">hage</span><span class="err">}</span><span class="w">
</span></span></span></code></pre></div><p>ex.【7.4 演習問題4(9:00)】</p>
<p>access_logテーブルから、user_idsession_countpage、セッション中のヒットカウント列を取得。
ヒットカウントは同一セッションにおける、何番目のヒットだったか？を表す整数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">session_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">page</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">hit_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">access_log</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|session_count|page            |hit_count|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |            2|/products/?id=7 |        1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |            2|/cart/cart.php  |        2|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|ABC    |            2|/products/?id=7 |        3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -- --------------------------------------------------[partition]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|ABC    |            1|/index.php      |        1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|ABC    |            1|/special/       |        2|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|ABC    |            1|/products/?id=1 |        3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |7|ABC    |            1|/products/?id=7 |        4|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |8|ABC    |            1|/products/?id=10|        5|
</span></span></span></code></pre></div><h4 id="-ナビゲーション-関数">■ ナビゲーション [関数]（）<a class="anchor" aria-hidden="true" href="#-ナビゲーション-関数"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="p">[</span><span class="err">関数</span><span class="p">](</span><span class="err">値を取得する対象カラム</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">hoge</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">fuga</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="err">{</span><span class="n">WINDOW</span><span class="w"> </span><span class="n">FRAME</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">{</span><span class="n">hage</span><span class="err">}</span><span class="w">
</span></span></span></code></pre></div><p>※ 様々なナビゲーション関数</p>
<pre tabindex="0"><code>FIRST_VALUE()     : ウィンドウフレームの中の一番最初の値を返す
LAST_VALUE()      : ウィンドウフレームの中の一番最後の値を返す
LEAD()            : 1行、もしくは指定した行数後ろのレコーその値を返す。
LAG()             : 1行、もしくは指定した行数前のレコーその値を返す。
NTH_VALUE()       :
PERCENTILE_COUNT():
PERCENTILE_DISC() :
</code></pre><h5 id="-first_value--">| FIRST_VALUE() -<a class="anchor" aria-hidden="true" href="#-first_value--"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="err">値を取得する対象カラム</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">hoge</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">fuga</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="err">{</span><span class="n">WINDOWF</span><span class="w"> </span><span class="n">RAME</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">{</span><span class="n">hage</span><span class="err">}</span><span class="w">
</span></span></span></code></pre></div><p>ex.【7.5 演習問題1(1:30)】</p>
<p>分析関数first_value()を利用して、trialデータセットのposテーブルから、「ユーザー別に初回購入した商品」を取得。購入の順番は、order_idが小さいほど早い。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_codd</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     product_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     unit_price,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     quantity,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     FIRST_VALUE(order_id) OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1">--         PARTITION BY user_id
</span></span></span><span class="line"><span class="cl"><span class="c1">--         ORDER BY user_id
</span></span></span><span class="line"><span class="cl"><span class="c1">--     )
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_trial.pos`;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">first_purchase_item</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|first_purchase_item|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |                  1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |                  1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|STU    |                  3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |9|www    |                  3|
</span></span></span></code></pre></div><p>ex.【7.5 演習問題2(4:10)】</p>
<p>trailデータセットのaccess_logテーブルを利用して、user_id、session_count、landing_page（セッション中のヒットを時系列的に並べた時の最初のページ）、exit_page（セッション中のヒットを時系列に並べた時の最後のページ）を取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">session_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">landing_page</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">exit_page</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">access_log</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|session_count|landing_page   |exit_page       |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |            1|/index.php     |/index.php      |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |            1|/index.php     |/special/       |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|ABC    |            1|/index.php     |/products/?id=10|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -----------------------------------------------------------[PARTITION]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|ABC    |            2|/products/?id=7|/products/?id=7 |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/***************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ※（問題点）exit_pageの項目がバラバラ問題
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    ∵ [WINDOW FRAME]がデフォルトの値が入ってしまっているから。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *       （設定しないと入ってしまう。）
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  [ROWS] [BETWEEN] UNBOUNDED PRECEDING [AND] CURRENT ROW
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  その為、パーテションの中での最初と最後の値を取得しているのではなく、
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  ウィンドウの中での最初の値、最後の値を取得している。
</span></span></span><span class="line"><span class="cl"><span class="cm"> ***************************************************************/</span><span class="w">
</span></span></span></code></pre></div><p>ex.【7.5 演習問題3(4:10)】</p>
<p>前問では、WINDOWFRAMがデフォルトの状態で取得してしまっている。
正しいexit_pageを取得。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">session_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- ROWS BETWEEN UNBOUNDED PRECEDING  AND UNBOUNDED FOLLOWING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">landing_page</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">FOLLOWING</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">exit_page</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">access_log</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|session_count|landing_page   |exit_page          |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |            1|/index.php     |/products/?id=10   |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |            1|/index.php     |/products/?id=10   |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|ABC    |            1|/index.php     |/products/?id=10   |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -- ------------------------------------------------------------[PARTITION]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|ABC    |            2|/products/?id=7|//thanks/thanks.php|
</span></span></span></code></pre></div><h5 id="-lead-lag">| LEAD()、 LAG()<a class="anchor" aria-hidden="true" href="#-lead-lag"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">LEAD</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">自分の今いる行の１行下の行の値を取得</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">LAG</span><span class="p">()</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="err">自分の今いる行の１行下の上の値を取得</span><span class="w">
</span></span></span></code></pre></div><p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="p">[</span><span class="err">関数</span><span class="p">](</span><span class="err">値を取得する対象カラム</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="err">行後</span><span class="p">,</span><span class="w"> </span><span class="err">値がな場合のデフォルト値</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">hoge</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">fuga</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">{</span><span class="n">WINDOW</span><span class="w"> </span><span class="n">FRAME</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">{</span><span class="n">hage</span><span class="err">}</span><span class="w">
</span></span></span></code></pre></div><p>ex.【7.5 演習問題4(13:20)】</p>
<p>access_logテーブルから、ページ毎の滞在時間（秒数）を、time_on_pageとして取得。
time_on_pageは、あるページがヒットされたdatetimeから、次のページがヒットされたdatetimeを差し引くことで求まる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     page,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     DATETIME_DIFF(
</span></span></span><span class="line"><span class="cl"><span class="c1">--         LEAD() OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1">--             PARTITION BY
</span></span></span><span class="line"><span class="cl"><span class="c1">--             ORDER BY
</span></span></span><span class="line"><span class="cl"><span class="c1">--         ),
</span></span></span><span class="line"><span class="cl"><span class="c1">--         LEAD() OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1">--             PARTITION BY
</span></span></span><span class="line"><span class="cl"><span class="c1">--             ORDER BY
</span></span></span><span class="line"><span class="cl"><span class="c1">--         ),
</span></span></span><span class="line"><span class="cl"><span class="c1">--         second) AS time_on_page
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_trial.access_log`;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">session_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">page</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">timestamp</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">--次の行のpageを取得
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">LEAD</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">next_page</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">--次の行のtimestampを取得
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">LEAD</span><span class="p">(</span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">next_hit_timestamp</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATETIME_DIFF</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">--次の行のtimestampを取得
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">LEAD</span><span class="p">(</span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">session_count</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">timestamp</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">second</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">time_on_page</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">access_log</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|session_count|page              |timestamp              |next_page         |next_hit_timestamp     |time_on_page|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |            1|/index.php        |2018-12-30 14:51:18 UTC|/special/         |2018-12-30 14:53:05 UTC|         107|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |            1|/special/         |2018-12-30 14:53:05 UTC|/products/?id=1   |2018-12-30 15:00:02 UTC|         417|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|ABC    |            1|/products/?id=1   |2018-12-30 15:00:02 UTC|/products/?id=7   |2018-12-30 15:00:30 UTC|          28|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|ABC    |            1|/products/?id=7   |2018-12-30 15:00:30 UTC|/products/?id=10  |2018-12-30 15:09:52 UTC|         562|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|ABC    |            1|/products/?id=10  |2018-12-30 15:09:52 UTC|null              |null                   |        null| ←離脱
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|ABC    |            2|/products/?id=7   |2019-01-03 16:04:32 UTC|/cart/cart.php    |2019-01-03 16:05:11 UTC|          39|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |7|ABC    |            2|/cart/cart.php    |2019-01-03 16:05:11 UTC|/thanks/thanks.php|2019-01-03 16:06:09 UTC|          58|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |7|ABC    |            2|/thanks/thanks.php|2019-01-03 16:06:09 UTC|null              |null                   |        null| ←離脱
</span></span></span></code></pre></div><h4 id="-集計分析-関数">■ 集計分析 [関数]（）<a class="anchor" aria-hidden="true" href="#-集計分析-関数"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>※ 様々な集計分析関数</p>
<pre tabindex="0"><code>SUM()  : パーテションの中の合計値を返す
AVG()  : パーテションの中の平均値を返す
COUNT(): パーテションの中の値の個数を返す
MAX()  : パーテションの中の最大値を返す
MIN()  : パーテションの中の最小値を返す
</code></pre><p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="p">[</span><span class="err">関数</span><span class="p">](</span><span class="err">値を取得する対象カラム</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">hoge</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="err">{</span><span class="n">fuga</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">{</span><span class="n">WINDOW</span><span class="w"> </span><span class="n">FRAME</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">{</span><span class="n">hage</span><span class="err">}</span><span class="w">
</span></span></span></code></pre></div><p>ex.【7.6 演習問題1(1:20)】</p>
<p>集計分析関数sum()を利用して、productsテーブルから、「ユーザー別の購入順累計quantity」を求めcumlative_ttlという別名を付与。購入の順番は、order_idが小さいほど早い。
（Aさんが、購入順に、２個、５個、６個と購入した場合、２、７、１３という累計値を取得したい。）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- (ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cumulative_ttl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|order_id|quantity|cumulative_ttl|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |       1|      10|            10|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |       2|       5|            15|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|ABC    |       3|       8|            23|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|ABC    |       9|      12|            35|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|ABC    |      10|       6|            41|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|STU    |       4|       8|             8|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |7|STU    |      11|       3|            11|
</span></span></span></code></pre></div><p>ex.【7.6 演習問題2(3:10)】</p>
<p>集計分析関数avg()を利用して、productsテーブルから、「ユーザー別の直近3回の購入金額の平均」を求めave_amount_3movingという別名を付与。購入順は、order_idが小さいほど早い。
（Aさんが、購入順に、２個、５個、６個、１個と購入した場合、2.0、3.5、4.3、4.0という移動平均値を取得したい。）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     unit_price,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     AVG(unit_price) OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1">--         PARTITION BY user_id
</span></span></span><span class="line"><span class="cl"><span class="c1">--         ORDER BY order_id
</span></span></span><span class="line"><span class="cl"><span class="c1">--         ROWS BETWEEN UNBOUNDED PRECEDING AND 2 PRECEDING
</span></span></span><span class="line"><span class="cl"><span class="c1">--     ) AS avg_amount_3moving
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_trial.pos`;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- -- SELECT (120+100+150)/3;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">unit_price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">unit_price</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="c1">--2行前から現在の行まで
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_amount_3moving</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|order_id|quantity|unti_price|sales_amount|avg_amount_3moving|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |       1|      10|       120|        1200|            1200.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |       2|       5|       100|         500|             850.0| (1200+500)/2
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|ABC    |       3|       8|       150|        1200|            966.77| (1200+500+1200)/3
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|ABC    |       9|      12|       160|        1920|           1206.67| (500+1200+1920)/3
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|ABC    |      10|       6|       200|        1200|            1440.0| (1200+1920+1200)/3
</span></span></span></code></pre></div><p>ex.【7.6 演習問題3(6:50)】</p>
<p>集計分析関数max()を利用して、posテーブルから、「ユーザー別に1回の買い物での過去最大のquantity」を取得し、lagest_qty_everという別名を付与。購入順番はorder_idが小さいほど早い。
（Aさんが、購入回数順に２個、５個、６個、４個と購入した場合、２、５、６、６という数値を取得したい。）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">unit_price</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">unit_price</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lagest_qty_ever</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|order_id|quantity|total_sales|lagest_qty_ever|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |       1|      10|       1200|           1200|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |       2|       5|        500|           1200|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|ABC    |       3|       8|       1200|           1200|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|ABC    |       9|      12|       1920|           1920|
</span></span></span></code></pre></div>
  <p></p>
</details>

<h4 id="section8--テーブル結合">SECTION8  ：テーブル結合<a class="anchor" aria-hidden="true" href="#section8--テーブル結合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <h3 id="-er図">| ER図<a class="anchor" aria-hidden="true" href="#-er図"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre><code>ER図（Entity-Relations）: テーブル同士の関係性を表した図表
</code></pre>
<p><img src="https://i.gyazo.com/14de2286b6d4ee7163677735cc745f61.png" alt="img"></p>
<pre tabindex="0"><code>そもそも、DBが複数のテーブルを持っているのは?
∵ カスタマイズ性、メンテナンス性を高めることが重視されているため。
</code></pre><h3 id="-キーの種類">| キーの種類<a class="anchor" aria-hidden="true" href="#-キーの種類"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre tabindex="0"><code>🔑 主キー(PK:PrimaryKey)   :
🗝 外部キー(FK:ForeignKey) : 外部テーブルと結合するためのキー
</code></pre><h3 id="-join---結合">| JOIN - 結合<a class="anchor" aria-hidden="true" href="#-join---結合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>※ JOINの種類</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="err">左右両方のテーブルに</span><span class="p">[</span><span class="n">FK</span><span class="o">=</span><span class="n">PK</span><span class="p">]</span><span class="err">が存在するレコードだけを結合（いずれにも該当しないレコードは弾かれる）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="err">左右にあろうが、無かろうが、兎に角「左を優先して！」結合</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="k">RIGHT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">左右にあろうが、無かろうが、兎に角「右を優先して！」結合</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="err">左右にあるだけのレコードを「全部まとめて出してくれ！」結合</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w">       </span><span class="p">:</span><span class="w">
</span></span></span></code></pre></div><p>e.g. 書式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="err">テーブル</span><span class="n">A</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">A</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="k">INNER</span><span class="o">|</span><span class="k">LEFT</span><span class="p">[</span><span class="k">OUTER</span><span class="p">]</span><span class="o">|</span><span class="k">RIGHT</span><span class="p">[</span><span class="k">OUTER</span><span class="p">]</span><span class="o">|</span><span class="k">FULL</span><span class="p">[</span><span class="k">OUTER</span><span class="p">])</span><span class="k">JOIN</span><span class="w"> </span><span class="err">テーブル</span><span class="n">B</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">B</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">→</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">FK</span><span class="o">-</span><span class="n">PKの両テーブルに共通するカラム</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">→</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">FK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">PK</span><span class="w"> </span><span class="p">[</span><span class="k">AND</span><span class="w"> </span><span class="err">絞り込み条件</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">デフォルト</span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="n">INNERや</span><span class="err">、</span><span class="n">OUTERは省略可能</span><span class="p">)</span><span class="err">。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="n">JOIN後は</span><span class="err">、</span><span class="n">USINGで共通キーを紐づける</span><span class="err">。更に詳細に設定する場合に</span><span class="n">ON句を使用</span><span class="err">。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="n">ON句の</span><span class="p">[</span><span class="k">AND</span><span class="w"> </span><span class="err">絞り込み条件</span><span class="p">]</span><span class="err">は省略可能。</span><span class="w">
</span></span></span></code></pre></div><h4 id="-usingでの結合">■ USINGでの結合<a class="anchor" aria-hidden="true" href="#-usingでの結合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">unit_price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">sm</span><span class="p">.</span><span class="n">category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">sm</span><span class="p">.</span><span class="n">prod_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">shohin_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--                [key]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |  |user_id|product_id|unit_price|category|prob_name|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | 1|ABC    |         1|       120|くだもの|いちご   |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | 2|XYZ    |         2|       200|野菜    |白菜     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | 3|STU    |         2|       200|野菜    |白菜     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | 4|STU    |         3|       160|野菜    |人参     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |15|www    |        11|       210|null    |null     |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- [shohin_master.csv]には無い値なので、nullが返る
</span></span></span></code></pre></div><h4 id="-on句による条件指定の結合">■ ON句による条件指定の結合<a class="anchor" aria-hidden="true" href="#-on句による条件指定の結合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">unit_price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sm</span><span class="p">.</span><span class="n">category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sm</span><span class="p">.</span><span class="n">prod_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">shohin_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;ABC&#34;</span><span class="w"> </span><span class="c1">-- ON句で詳細設定しての結合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--     [条件]    [key]
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |user_id|product_id|unit_price|quantity|category|prod_name|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |         1|       120|      10|くだもの |いちご  |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|XYZ    |         2|       200|       2|null    |null     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|STU    |         2|       200|       3|null    |null     |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- LEFT JOIN での結合のため、左側の全て取得しnullが返ってしまう。
</span></span></span><span class="line"><span class="cl"><span class="c1">-- この場合は、INNER JOINを使用すると、意図する挙動になる。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">shohin_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|product_id|unit_price|quantity|category|prod_name|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |         1|       120|      10|くだもの |いちご  |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |         4|       160|      12|魚       |アジ    |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|ABC    |         5|       100|       5|肉       |豚肉    |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更にON句では AND で条件を追加もできる。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;ABC&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">category</span><span class="o">=</span><span class="s2">&#34;肉&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="c1">--[条件]-- --[key]--                   --[条件]--
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |user_id|product_id|unit_price|quantity|category|prod_name|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |         5|       100|       5|肉      |豚肉     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ABC    |        10|       150|       8|肉      |豚肉     |
</span></span></span></code></pre></div><h4 id="結合例外処理注意">■結合例外処理（注意）<a class="anchor" aria-hidden="true" href="#結合例外処理注意"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>e.g. 主キー(PK)の重複により要件を満たさないテーブルの結合</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">unit_price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">smb</span><span class="p">.</span><span class="n">category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">smb</span><span class="p">.</span><span class="n">prod_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">shohin_master_bad</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">smb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|product_id|unit_price|qunantity|category|prod_name |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|STU    |         3|       160|        8|野菜     |人参     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|STU    |         3|       160|        8|野菜     |人参     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|WWW    |         3|       160|        5|野菜     |人参     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|WWW    |         3|       160|        5|野菜     |人参     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|XYZ    |         3|       160|        2|野菜     |人参     |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|XYZ    |         3|       160|        2|野菜     |人参     |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/****************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * (問題点)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * pos.csvには、product_id＝３番は３レコード存在している。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * shohin_master_bad.csvには本来PKは一意に存在しなくてはいけないところ、product_id３番が重複していた。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * その結果、結合後に3レコード取るはずが、倍の6レコード取得されてしまっていた。(重複分が招いた、問題点)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 集計時に二重計上による誤差になりかねない💀
</span></span></span><span class="line"><span class="cl"><span class="cm"> ****************************************************************/</span><span class="w">
</span></span></span></code></pre></div><p>ex.【8.5 演習問題1(0:20)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">-- sp.purchase_id, sp.date, sp.user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">-- c.gender,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">CASE</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">gender</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;mele&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;female&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="s2">&#34;unknow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">-- CONCAT(c.last_name, &#34; &#34;, c.first_name) AS full_name,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">shop_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">shop_quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="o">/</span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">quantity</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">gender</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">total_amount</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |gender|shop_count|shop_quantity|total_amount|avg_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|female|       792|         1819|    11456055|    6298.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|male  |       450|          984|     7969220|    8099.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|unknow|        40|           92|      693117|    7534.0|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- #Q1. female
</span></span></span><span class="line"><span class="cl"><span class="c1">-- #Q2. female
</span></span></span><span class="line"><span class="cl"><span class="c1">-- #Q3. female
</span></span></span><span class="line"><span class="cl"><span class="c1">-- #Q4. male
</span></span></span></code></pre></div><p>ex.【8.5 演習問題2(3:50)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     -- *,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     -- sp.user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     -- (&#34;2018-12-31&#34;- c.birthday)/365 AS age,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     ROUND(DATE_DIFF(date&#34;2018-12-31&#34;, c.birthday, DAY)/365) AS age,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     CASE(c.gender)
</span></span></span><span class="line"><span class="cl"><span class="c1">--         WHEN 1 THEN &#34;mele&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">--         WHEN 2 THEN &#34;female&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">--         ELSE &#34;unknow&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">--     END AS gender,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     ROUND(AVG(quantity),1) AS avg_quantity
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_sample.shop_purchases` AS sp
</span></span></span><span class="line"><span class="cl"><span class="c1">-- LEFT JOIN `prj-test3.bq_sample.customers` AS c
</span></span></span><span class="line"><span class="cl"><span class="c1">-- USING(user_id)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- GROUP BY gender, age
</span></span></span><span class="line"><span class="cl"><span class="c1">-- HAVING gender != &#34;unknow&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ORDER BY 3 DESC
</span></span></span><span class="line"><span class="cl"><span class="c1">-- LIMIT 3;
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |age |gender|avg_quantity|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|32.0|male  |         3.7|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|44.0|male  |         3.3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|62.0|male  |         3.0|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nenrei</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">gender</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;男性&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;女性&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seibetsu</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">quantity</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_aty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">nenrei</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">avg_aty</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |nenrei |seibetsu|avg_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|     31|男性    |     3.5|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|     66|女性    |     3.2|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|     62|男性    |     3.1|
</span></span></span></code></pre></div><p>ex.【8.5 演習問題3(7:30)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CONCAT</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34; &#34;</span><span class="p">,</span><span class="k">c</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">full_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">c</span><span class="p">.</span><span class="n">Is_premium</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w">  </span><span class="c1">--プレミアム会員以外
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">last_name</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">full_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">total_amount</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |full_name|total_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|小杉 信貴 |      104500|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|宗村 良崇 |       60216|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|和栗 昇悟 |       59400|
</span></span></span></code></pre></div><h3 id="-複数テーブルの結合">| 複数テーブルの結合<a class="anchor" aria-hidden="true" href="#-複数テーブルの結合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>e.g. 書式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="err">テーブル</span><span class="n">A</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">A</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="k">INNER</span><span class="o">|</span><span class="k">LEFT</span><span class="p">[</span><span class="k">OUTER</span><span class="p">]</span><span class="o">|</span><span class="k">RIGHT</span><span class="p">[</span><span class="k">OUTER</span><span class="p">]</span><span class="o">|</span><span class="k">FULL</span><span class="p">[</span><span class="k">OUTER</span><span class="p">])</span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="err">テーブル</span><span class="n">B</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">B</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">→</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">FK</span><span class="o">-</span><span class="n">PKの両テーブルに共通するカラム</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">→</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">FK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">PK</span><span class="w"> </span><span class="p">[</span><span class="k">AND</span><span class="w"> </span><span class="err">絞り込み条件</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="k">INNER</span><span class="o">|</span><span class="k">LEFT</span><span class="p">[</span><span class="k">OUTER</span><span class="p">]</span><span class="o">|</span><span class="k">RIGHT</span><span class="p">[</span><span class="k">OUTER</span><span class="p">]</span><span class="o">|</span><span class="k">FULL</span><span class="p">[</span><span class="k">OUTER</span><span class="p">])</span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="err">テーブル</span><span class="k">C</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">C</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">→</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">FK</span><span class="o">-</span><span class="n">PKの両テーブルに共通するカラム</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">→</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">FK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">PK</span><span class="w"> </span><span class="p">[</span><span class="k">AND</span><span class="w"> </span><span class="err">絞り込み条件</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>ex.【8.6 演習問題1(2:10)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     s.shop_name,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     s.chief_name,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     SUM(sp.sales_amount) AS total_amount,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     CASE c.gender
</span></span></span><span class="line"><span class="cl"><span class="c1">--         WHEN 1 THEN &#34;male&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">--         WHEN 2 THEN &#34;female&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">--         ELSE &#34;unknow&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">--     END AS gender
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_sample.shop_purchases` AS sp
</span></span></span><span class="line"><span class="cl"><span class="c1">-- LEFT JOIN `prj-test3.bq_sample.customers` AS c USING(user_id)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- LEFT JOIN `prj-test3.bq_sample.products_master` AS p USING(product_id)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- LEFT JOIN `prj-test3.bq_sample.shops_master` AS s USING(shop_id)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- GROUP BY s.shop_name, s.chief_name, gender
</span></span></span><span class="line"><span class="cl"><span class="c1">-- HAVING gender = female
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ORDER BY 1, 3 DESC;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sm</span><span class="p">.</span><span class="n">chief_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">tencho</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sm</span><span class="p">.</span><span class="n">shop_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">shop_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">gender</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;male&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;female&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">customer_gender</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">kyakusuu</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">uriage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pm</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shops_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">shop_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">gender</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tencho</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sm</span><span class="p">.</span><span class="n">shop_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">customer_gender</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">customer_gender</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">uriage</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |tencho     |shop_name  |customer_gnder|kyakusuu|uriage |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|柳澤 華子  |自由が丘店 |female        |     306|4721503|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|山下 唐三郎|下北沢店   |female        |     258|4476825|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |5|柳澤 華子  |自由が丘店 |male          |     172|4004558|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |6|山下 唐三郎|下北沢店   |male          |     145|2713434|
</span></span></span></code></pre></div><p>ex.【8.6 演習問題2(7:30)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">chief_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">chief</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shops_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sp</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-03-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-03-31&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">-- DATE_TRUNC(sp.date, month) = &#34;2018-03-01&#34; #別解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">prefecture</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&#34;Tokyo&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">gender</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">prod_gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;f&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">chief</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |sales_count|total_amount|chief        |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|          3|      142276|大井谷 みすず|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|          4|      108905|山下 唐三郎  |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|          2|       80667|柳澤 華子    |
</span></span></span></code></pre></div><p>ex.【8.6 演習問題3(10:20)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">-- s.shop_name AS shop_name,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">prod_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_amoount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">min_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="o">-</span><span class="k">MIN</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shops_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">shop_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">shop_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">chief_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;大井谷　みすず&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">Is_premium</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">diff_amount</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">limit</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |product      |max_amoount|min_amount|diff_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ブラウス 長袖|      73000|     12775|      60225|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="p">(</span><span class="n">other</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pm</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shops_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">shop_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sm</span><span class="p">.</span><span class="n">chief_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;大井谷%&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">Is_premium</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">TRUE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pm</span><span class="p">.</span><span class="n">prod_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |product      |max_amoount|min_amount|diff_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ブラウス 長袖|      73000|     12775|      60225|
</span></span></span></code></pre></div>
  <p></p>
</details>

<h4 id="section9--サブクエリ">SECTION9  ：サブクエリ<a class="anchor" aria-hidden="true" href="#section9--サブクエリ"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <h3 id="-サブクエリ-副問い合わせ">| サブクエリ（= 副問い合わせ）<a class="anchor" aria-hidden="true" href="#-サブクエリ-副問い合わせ"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>何ができるの？</p>
<pre tabindex="0"><code>・「全体」と「個別」の対比。（全体の売上を100%とした時、特定の売上は○%を占める。）
・JOINを用いずとも、他のテーブルデータ利用。（JOINをせずにある属性の顧客から売上合計金額データを取得。）
・一度集計したデータの利用。（日別に売上を合算したえ上でそれらの平均を取得できるようになる。）...etc.

※ 実行順序は、「サブクエリ（子クエリ）」&gt;「親クエリ」
</code></pre><p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="err">①</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |ttl_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|     90|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="err">②</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qty_by_user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">  </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|qty_by_user|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |         41|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|XYZ    |         19|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|WWW    |          7|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="err">①</span><span class="o">+</span><span class="err">②</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qty_by_user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">-- ①をttl_qtyとして使用可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">  </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|qty_by_user|ttl_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |         41|     90|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|STU    |         23|     90|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|XYZ    |         19|     90|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|WWW    |          7|     90|
</span></span></span></code></pre></div><p>ex.【9.2 演習問題1 (6:20)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qty_by_user</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_aty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pctg_by_user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|qty_by_user|ttl_qty|pctg_by_yser|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |         41|     90|        45.6|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|STU    |         23|     90|        25.6|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|XYZ    |         19|     90|         7.8|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|WWW    |          7|     90|        21.0|
</span></span></span></code></pre></div><h3 id="-サブクエリの戻り値の型">| サブクエリの戻り値の型<a class="anchor" aria-hidden="true" href="#-サブクエリの戻り値の型"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre tabindex="0"><code>1. スカラー     : 単一の値    [n]
2. ベクター     : リストの値  [n行×1列]
3. マトリックス : 表の値      [n行×m列]
</code></pre><table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: center">スカラー</th>
          <th style="text-align: center">ベクター</th>
          <th style="text-align: center">マトリックス</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>SELECT句</td>
          <td style="text-align: center">●</td>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td>FROM句</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">●</td>
          <td style="text-align: center">●</td>
      </tr>
      <tr>
          <td>WHERE句</td>
          <td style="text-align: center">●</td>
          <td style="text-align: center">●</td>
          <td style="text-align: center"></td>
      </tr>
  </tbody>
</table>
<h4 id="-スカラー">■ スカラー<a class="anchor" aria-hidden="true" href="#-スカラー"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>ex.【9.3 演習問題1 (2:10)】(WHERE句 × スカラー)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">ROUND</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">ROUND</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">quantity</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |order_id|quantity|avg_aty|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|       9|      12|    6.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|      12|      12|    6.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|       1|      10|    6.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|       3|       8|    6.0|
</span></span></span></code></pre></div><p>ex.【9.4 演習問題1 (1:10)】(SELECT句 × スカラー)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |order_id|user_id|product_id|quantity|ttl_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|       1|ABC    |         1|      10|     90|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|       2|ABC    |         5|       5|     90|
</span></span></span></code></pre></div><p>ex.【9.4 演習問題2 (4:20)】(SELECT句 × スカラー)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     SUM(unit_price*quantity) AS sales_by_user,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     (SELECT SUM(sales_amount) FROM `prj-test3.bq_sample.shop_purchases`) AS ttl_sales,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     SUM(unit_price*quantity)/(SELECT SUM(sales_amount) FROM `prj-test3.bq_sample.shop_purchases`) AS sales_share_by_user
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- FROM `prj-test3.bq_trial.pos`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- GROUP BY user_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- ORDER BY 2 DESC;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">colect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="o">*</span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_by_user</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="o">*</span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">ROUND</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="o">*</span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="o">*</span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_share_by_user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|sales_by_user|ttl_sales|sales_share_by_user|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ABC    |         6020|    14240|               42.3|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|XYZ    |         3920|    14240|               27.5|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|STU    |         3080|    14240|               21.6|
</span></span></span></code></pre></div><p>ex.【9.4 演習問題3 (7:20)】(SELECT句 × スカラー)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_by_month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">ROUND</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_ratio</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">month</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">month</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |month     |sales_by_month|ttl_sales|sales_ratio|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|2018-01-01|       2056764| 20118392|       10.2|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|2018-02-01|       1133128| 20118392|        5.6|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|2018-03-01|       1296473| 20118392|        6.4|
</span></span></span></code></pre></div><p>ex.【9.5 演習問題1 (0:40)】(WHERE句 × スカラー)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="c1">-- *,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="n">purchase_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">sales_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |purchase-id|sales_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1|        995|       99000|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |2|       1203|       99000|
</span></span></span></code></pre></div><p>ex.【9.5 演習問題2 (3:15)】(WHERE句 × スカラー)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="c1">-- *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34; &#34;</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">birthday</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">ROUND</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">)))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_age</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">ROUND</span><span class="p">(</span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">)))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="k">AS</span><span class="w"> </span><span class="n">stddev_age</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">-- age BETWEEN (avg_age + std_age) AND (avg_age - std_age) #(別解)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- |   |user_id|fullname   |birthday  |age|avg_age|stddev_age|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |  1|1105505|松元 陽彦  |1960-05-02| 58|   43.0|      15.0|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |  2|1105505|秋山 充康  |1960-09-26| 58|   43.0|      15.0|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |529| 962102|井ノ口 京香|1989-05-16| 29|   43.0|      15.0|
</span></span></span></code></pre></div><p>ex.【9.5 演習問題3 (11:10)】(WHERE句 × スカラー)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_in_target</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_user_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">ROUND</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">percentage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">BETWEEN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">-</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |user_in_target|total_user_count|percentage|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1|           529|             944|      56.0|
</span></span></span></code></pre></div><h4 id="-ベクター">■ ベクター<a class="anchor" aria-hidden="true" href="#-ベクター"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>ex.【9.6 演習問題1 (1:12)】(WHERE句 × ベクター)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     SUM(quantity*sales_amount) AS sales_by_users
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- FROM `prj-test3.bq_sample.shop_purchases`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- WHERE (SELECT gender FROM `prj-test3.bq_sample.customers`)=2;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">...</span><span class="mi">34</span><span class="p">.</span><span class="mi">58</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_by_users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |user_id|sales_by_users|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1| 497520|         31518|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |2| 529565|          3860|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">other_code</span><span class="p">...</span><span class="mi">34</span><span class="p">.</span><span class="mi">58</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">sp</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="w"> </span><span class="p">)</span><span class="k">AS</span><span class="w"> </span><span class="n">sales_by_users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |user_id|sales_by_users|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1| 497520|         31518|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |2| 529565|          3860|
</span></span></span></code></pre></div><p>ex.【9.6 演習問題2 (4:25)】(WHERE句 × ベクター)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34; &#34;</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">prefecture</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">birthday</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">AND</span><span class="w"> </span><span class="n">prefecture</span><span class="o">=</span><span class="s2">&#34;Tokyo&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">AND</span><span class="w"> </span><span class="n">gender</span><span class="o">=</span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">(</span><span class="s2">&#34;Asia/Tokyo&#34;</span><span class="p">)</span><span class="o">-</span><span class="n">birthday</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |user_id|fullname    |prefecture|birthday  |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1|1033150|羽諸 一未  |Tokyo      |1947-08-14|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |2|1089412|巴山 かのこ|Tokyo      |1951-03-31|
</span></span></span></code></pre></div><p>e.g. 日別の販売数量平均を知りたい場合。等</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="err">①</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sum_of_qty_by_day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |sum_of_qty_by_day|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1|               45|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |2|               45|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="err">②</span><span class="p">:</span><span class="w"> </span><span class="err">①をサブクエリとして利用。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">AVG</span><span class="p">(</span><span class="n">sum_of_qty_by_day</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_qty_by_day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sum_of_qty_by_day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |avg_qty_by_day|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1|          45.0|
</span></span></span></code></pre></div><p>ex.【9.7 演習問題1 (3:20)】(FROM句 × ベクター)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">AVG</span><span class="p">(</span><span class="n">sold_by_day</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_number_of__prob_sold_by_day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">COUNT</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sold_by_day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |avg_number_of__prob_sold_by_day|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1|                            7.5|
</span></span></span></code></pre></div><p>ex.【9.7 演習問題2 (6:10)】(FROM句 × ベクター)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">MAX</span><span class="p">(</span><span class="n">month_of_pv</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_month_of_pv</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">MIN</span><span class="p">(</span><span class="n">month_of_pv</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">min_month_of_pv</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">AVG</span><span class="p">(</span><span class="n">month_of_pv</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_month_of_pv</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">STDDEV_POP</span><span class="p">(</span><span class="n">month_of_pv</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">std_month_of_pv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DATETIME_TRUNC</span><span class="p">(</span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SUM</span><span class="p">(</span><span class="n">pageview</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">month_of_pv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">web_usage</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="c1">-- | |month              |month_of_pv|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="c1">-- |1|2018-01-01T00:00:00|        175|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="c1">-- |1|2018-02-01T00:00:00|        233|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- | |max_month_of_pv|min_month_of_pv|avg_month_of_pv|std_month_of_pv  |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- |1|            320|            118|          216.5|53.40958091329058|
</span></span></span></code></pre></div><h4 id="-マトリックス">■ マトリックス<a class="anchor" aria-hidden="true" href="#-マトリックス"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<p>ex.【9.8 演習問題1 (3:30)】(FROM句 × マトリックス)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">ROUND</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">day_of_total_amount</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_sales_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="nb">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">day_of_total_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="c1">--| |shop_id|date      |day_of_total_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">       </span><span class="c1">--|1|      1|2018-01-01|              30948|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">--| |shop_id|avg_sales_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|1|      1|         32236.0|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|2|      2|         28963.0|
</span></span></span></code></pre></div><p>ex.【9.8 演習問題2 (5:10)】(FROM句 × マトリックス)</p>
<p>(※ 7.4でerrorとなった演習をサブクエリを用いて改修。）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">order_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">quantity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">--| |order_id|user_id|quantity|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="c1">--|1|       9|ABC    |      12|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">--| |user_id|quantity|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|1|ABC    |      12|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|2|ABC    |      10|   2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|3|ABC    |       8|   3|
</span></span></span></code></pre></div><h3 id="-サブクエリとjoinの併用">| サブクエリとJOINの併用<a class="anchor" aria-hidden="true" href="#-サブクエリとjoinの併用"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nb">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">quantity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;ABC&#34;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">shohin_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |date      |user_id|category|quantity|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|2019-01-01|ABC    |くだもの|      10|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|2019-01-01|ABC    |肉      |       5|
</span></span></span></code></pre></div><p>ex.【9.9 演習問題1 (2:30)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     sm.category,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     SUM(pos.quantity) AS total_quantity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- FROM (SELECT * FROM `prj-test3.bq_trial.pos` WHERE quantity &gt;= 10) AS pos
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- LEFT JOIN `prj-test3.bq_trial.shohin_master`AS sm USING(product_id)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- GROUP BY 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- ORDER BY 1 DESC;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--| |category|total_quantity|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|1|魚      |            24|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|2|くだもの |            10|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">sm</span><span class="p">.</span><span class="n">category</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SUM</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">qty_by_prob</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qty_by_prob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">pos</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">HAVING</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="c1">--| |product_id|qty_by_prob|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">       </span><span class="c1">--|1|         5|         13|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">shohin_master</span><span class="o">`</span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">category</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">--| |category|ttl_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|1|肉      |     13|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|2|野菜    |     30|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|3|魚      |     24|
</span></span></span></code></pre></div><p>ex.【9.9 演習問題2 (6:50)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--   c.prefecture
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--   RANK() OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     PARTITION BY c.prefecture
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--     ORDER BY sp_ttl.total_amount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--   ) AS rank
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- FROM (SELECT *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--       FROM `prj-test3.bq_sample.customers`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--       WHERE prefecture IS NOT NULL) AS c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- LEFT JOIN (SELECT user_id, SUM(sales_amount) AS total_amount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--           FROM `prj-test3.bq_sample.shop_purchases`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--           GROUP BY 1) AS sp_ttl ON c.user_id=sp_ttl.user_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- LEFT JOIN `prj-test3.bq_sample.shop_purchases` AS sp ON c.user_id=sp.user_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">cu</span><span class="p">.</span><span class="n">prefecture</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pref</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">sp</span><span class="p">.</span><span class="n">purchase_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">prefecture</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="n">cu</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="c1">--| |pref      |purches_id|sales_amount|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">       </span><span class="c1">--|1|Saitama   |       178|        1930|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pref</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pref</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">--| |pref      |purches_id|sales_amount|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|1|Aichi     |       193|       75270|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|2|Aichi     |       247|       43800|   2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|3|Aichi     |       535|       43800|   2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">--|1|Aomori    |       206|       22000|   1|
</span></span></span></code></pre></div><p>ex.【9.9 演習問題 (11:10)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">--|pref |prodcut_id|ttl_sales_amount|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|Tokyo|       120|         5000000|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">cu</span><span class="p">.</span><span class="n">prefecture</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pref</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">sp</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">prefecture</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">pref</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">rank</span><span class="o">&lt;=</span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pref</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |pref  |prodcut_id|total_sales|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|Aichi |        9|      111360|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|Aichi |       10|      102200|   2|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|3|Aichi |        4|       90324|   3|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|Aomori|        6|       22000|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">prefecture</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">prefecture</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales_rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="n">cu</span><span class="p">.</span><span class="n">prefecture</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="n">sp</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">prefecture</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">prefecture</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sales_rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |pref  |prodcut_id|total_sales|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|Aichi |        9|      111360|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|Aichi |       10|      102200|   2|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|3|Aichi |        4|       90324|   3|
</span></span></span></code></pre></div><h3 id="-with句---サブクエリの可読性を高める">| WITH句 - サブクエリの可読性を高める<a class="anchor" aria-hidden="true" href="#-with句---サブクエリの可読性を高める"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre tabindex="0"><code>※書式
    WITH
    [後から参照する名前1] AS (SELECT句から始まるサブクエリ1),
    [後から参照する名前2] AS (SELECT句から始まるサブクエリ2)

あたかも予め用意された様なテーブルデータとして
結合させたり、利用できたりする。
</code></pre><p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">agg</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">--| |month     |shop_id|total_sales|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">agg</span><span class="p">.</span><span class="k">month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">sm</span><span class="p">.</span><span class="n">chief_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SUM</span><span class="p">(</span><span class="n">agg</span><span class="p">.</span><span class="n">total_sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shops_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">agg</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">agg</span><span class="p">.</span><span class="n">shop_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm</span><span class="p">.</span><span class="n">shop_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |month     |chief_name   |sales |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|2018-01-01|大井谷 みすず|435091|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|2018-01-01|山下  唐三郎 |723369|
</span></span></span></code></pre></div>
  <p></p>
</details>

<h4 id="section10-集合演算ビュー">SECTION10 ：集合演算、ビュー<a class="anchor" aria-hidden="true" href="#section10-集合演算ビュー"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <h3 id="-テーブル同士の集合演算">| テーブル同士の集合演算<a class="anchor" aria-hidden="true" href="#-テーブル同士の集合演算"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<pre tabindex="0"><code>1. 和集合 A∩B（AかつB）
    →重複を除外しないパターン、重複を除外するパターン
</code></pre><pre tabindex="0"><code>2. 積集合 A∪B（AまたはB）
    →重複部分のみ
</code></pre><pre tabindex="0"><code>3. 差集合 A∩!B（AかつノットB）
    →重複と該当データ以外を差し引く
</code></pre><h3 id="-union---和集合">| UNION - 和集合<a class="anchor" aria-hidden="true" href="#-union---和集合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<blockquote>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Venn_A_union_B.png/220px-Venn_A_union_B.png" alt="img"></p>
<ul>
<li>Cf. <a href="https://ja.wikipedia.org/wiki/%E5%92%8C%E9%9B%86%E5%90%88">和集合 - Wikipedia</a></li>
</ul></blockquote>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table1</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">ALL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">DISTINCT</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table2</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">同じ列数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">同じ列の順序で（同じ列名であっても順番まで問われる）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">重複を無視：</span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="err">（</span><span class="p">[</span><span class="n">table1</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">table2</span><span class="p">]</span><span class="err">の列数）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">重複を除外：</span><span class="k">UNION</span><span class="w"> </span><span class="k">DISTINCT</span><span class="err">（</span><span class="p">[</span><span class="n">table1</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">table2</span><span class="p">]</span><span class="o">-</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span><span class="err">の列数）</span><span class="w">
</span></span></span></code></pre></div><p>ex.【10.3 演習問題1(5:30)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- SELECT COUNT(*) FROM `prj-test3.bq_trial.event_jan`; --5record
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT COUNT(*) FROM `prj-test3.bq_trial.event_feb`; --6record
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |date      |place|last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|2019-02-15|渋谷 |山本     |大輔      |男性  | 29|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|2019-02-15|渋谷 |山田     |太郎      |男性  | 28|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |9|2019-01-15|池袋 |山田     |太郎      |男性  | 28|
</span></span></span></code></pre></div><p>eg. 2つ以上のテーブルUNION</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table1</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">ALL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">DISTINCT</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table2</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">ALL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">DISTINCT</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table3</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>eg. UNIONタイプを複合
→ ([table1]+[table2])+[table3]-[dist]</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table1</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table2</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table3</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>ex.【10.3 演習問題2(8:50)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_mar</span><span class="o">`</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |date      |place|last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|2019-02-15|渋谷 |高田     |みすず    |女性  | 20|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|2019-01-15|池袋 |山田     |華子      |女性  | 25|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|3|2019-02-15|渋谷 |山田     |太郎      |男性  | 28|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="err">サブクエリを用いて、親クエリでフィルタリングする。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_mar</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">gender</span><span class="o">=</span><span class="s2">&#34;女性&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |date      |place|last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|2019-02-15|渋谷  |高田    |みすず    |女性  | 20|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|2019-01-15|池袋  |山田    |華子      |女性  | 25|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|3|2019-03-15|品川  |高橋    |純子      |女性  | 28|
</span></span></span></code></pre></div><p>ex.【10.3 演習問題3(13:20)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT * FROM `prj-test3.bq_trial.event_jan`
</span></span></span><span class="line"><span class="cl"><span class="c1">-- UNION DISTINCT
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT * FROM `prj-test3.bq_trial.event_feb`;
</span></span></span><span class="line"><span class="cl"><span class="c1">--| |date      |place|last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|2019-02-15|渋谷 |山本     |大輔      |男性  | 29|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|2019-02-15|渋谷 |山田     |太郎      |男性  | 28|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|3|2019-02-15|渋谷 |本田     |健太郎    |男性  | 35|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |last_name|first_na|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|山本     |大輔    |男性  | 29|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|山田     |太郎    |男性  | 28|
</span></span></span></code></pre></div><p>ex.【10.3 演習問題4(17:20)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">UNION</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">UNION</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_mar</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |f0_|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1| 14|
</span></span></span></code></pre></div><h3 id="-intersect---積集合">| INTERSECT - 積集合<a class="anchor" aria-hidden="true" href="#-intersect---積集合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<blockquote>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/Interseccion.svg/250px-Interseccion.svg.png" alt="img"></p>
<ul>
<li>Cf. <a href="https://ja.wikipedia.org/wiki/%E5%85%B1%E9%80%9A%E9%83%A8%E5%88%86_(%E6%95%B0%E5%AD%A6)">共通部分（数学） - Wikipedia</a></li>
<li>Cf. <a href="https://ja.wikipedia.org/wiki/%E3%83%89%E3%83%BB%E3%83%A2%E3%83%AB%E3%82%AC%E3%83%B3%E3%81%AE%E6%B3%95%E5%89%87">ド・モルガンの法則 - Wikipedia</a></li>
</ul></blockquote>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table1</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table2</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">同じ列数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">同じ列の順序で（同じ列名であっても順番まで問われる）</span><span class="w">
</span></span></span></code></pre></div><p>ex.【10.4 演習問題1(1:50)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|山田     |太郎      |男性  | 28|
</span></span></span></code></pre></div><p>ex.【10.4 演習問題1(1:50)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_mar</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|山田     |太郎      |男性  | 28|
</span></span></span></code></pre></div><p>ex.【10.4 演習問題3(5:20)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_mar</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|山田     |太郎     |男性   | 28|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|高橋     |純子     |女性   | 28|
</span></span></span></code></pre></div><h3 id="-except---差集合">| EXCEPT - 差集合<a class="anchor" aria-hidden="true" href="#-except---差集合"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<blockquote>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/Venn0100.svg/220px-Venn0100.svg.png" alt="img"></p>
<ul>
<li>Cf. <a href="https://ja.wikipedia.org/wiki/%E5%B7%AE%E9%9B%86%E5%90%88">差集合 - Wikipedia</a></li>
</ul></blockquote>
<p>e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table1</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXCEPT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="k">column</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">table2</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">同じ列数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">同じ列の順序で（同じ列名であっても順番まで問われる）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">※</span><span class="w"> </span><span class="err">テーブルの順序によって引き算した場合結果は異なる。（</span><span class="n">eg</span><span class="p">.</span><span class="w"> </span><span class="mi">5</span><span class="err">行</span><span class="o">-</span><span class="mi">2</span><span class="err">行</span><span class="o">=</span><span class="mi">2</span><span class="err">行</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="err">行</span><span class="o">-</span><span class="mi">5</span><span class="err">行</span><span class="o">=-</span><span class="mi">2</span><span class="err">行）</span><span class="w">
</span></span></span></code></pre></div><p>ex.【10.5 演習問題1(2:40)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXCEPT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|山本     |大輔      |男性  | 29|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|本田     |健太郎    |男性  | 35|
</span></span></span></code></pre></div><p>ex.【10.5 演習問題2(4:50)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_mar</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXCEPT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|鈴木      |輝夫     |男性  | 30|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|橋田      |睦       |男性  | 30|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 計4名
</span></span></span></code></pre></div><p>ex.【10.5 演習問題3(6:50)】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- (SELECT last_name, first_name, gender, age FROM `prj-test3.bq_trial.event_mar`
</span></span></span><span class="line"><span class="cl"><span class="c1">-- UNION DISTINCT
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT last_name, first_name, gender, age FROM `prj-test3.bq_trial.event_jan`)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- EXCEPT DISTINCT
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT last_name, first_name, gender, age FROM `prj-test3.bq_trial.event_feb`;
</span></span></span><span class="line"><span class="cl"><span class="c1">--
</span></span></span><span class="line"><span class="cl"><span class="c1">--| |last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|鈴木     |輝夫      |男性  | 30|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|橋田     |睦        |男性  | 30|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 計8名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="p">(</span><span class="n">collect_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_mar</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_jan</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXCEPT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_trial</span><span class="p">.</span><span class="n">event_feb</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |last_name|first_name|gender|age|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|高橋     |純子      |女性  | 28|
</span></span></span></code></pre></div><hr>
<h3 id="-ビュー">| ビュー<a class="anchor" aria-hidden="true" href="#-ビュー"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="err">ある程度複雑化した、</span><span class="n">SQLを呼び出せる形で保存ができる便利機能</span><span class="err">。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">テーブルの様な振る舞いではあるが、実際では</span><span class="n">SQLである</span><span class="err">。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">eg</span><span class="p">.</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol>
<li>ビューの保存（作成）
<img src="https://i.gyazo.com/1df5f397b46f95b369f57ad92b592957.png" alt="img"></li>
</ol>
<pre tabindex="0"><code>記載したSQLを保存のメニューバーから、「ビューを保存」を選択。
</code></pre><ol start="2">
<li>保存名設定
<img src="https://i.gyazo.com/e6c369473d2b6c0fc020e836c003e587.png" alt="img"></li>
</ol>
<pre tabindex="0"><code>保存先や、テーブル名を設定。
（ここでは、`joined_sp_pm`とする。）
</code></pre><ol start="3">
<li>ビューの確認
<img src="https://i.gyazo.com/b8ac13d91a7b5ec9798445272955f62e.png" alt="img"></li>
</ol>
<pre tabindex="0"><code>左側のプロジェクト一覧から、ドリルダウンしていくと、指定したビューが作成されている。
</code></pre><ol start="4">
<li>ビューの呼び出し</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w">  </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">joined_sp_pm</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div>
  <p></p>
</details>

<h4 id="section11-練習問題">SECTION11 ：練習問題<a class="anchor" aria-hidden="true" href="#section11-練習問題"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <h3 id="-難易度低">| 難易度：低<a class="anchor" aria-hidden="true" href="#-難易度低"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>■ practice 11.2 (難易度:低)</p>
<p>平成生まれ（平成は1989年1月8日〜2019年4月30日まで）の男性で最も人気のファーストネームはなんですか？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">goal_image</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |first_name|count|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RANK</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">gender</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="c1">--男性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">birthday</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;1989-01-08&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2019-04-30&#34;</span><span class="w"> </span><span class="c1">-- 平成産まれ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |first_name|count|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|匠        |    2|   1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (1.6s 22KB)
</span></span></span></code></pre></div><p>■ practice 11.3 (難易度:低)</p>
<p>都道府県別の平均年齢が最も高い都道府県は？
customersテーブルを利用して、都道府県と平均年齢（小数点以下を四捨五入して）を整数で回答。
但、5人以上顧客がいるえ都道府県のみを対象。年齢は2018年12月31日時点での満年齢で計算。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">goal_image</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |pref|avg_age|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prefecture</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pref</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">AVG</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">-- CAST(FORMAT_DATE(&#34;%Y&#34; ,DATE_TRUNC(CURRENT_DATE(&#34;Asia/Tokyo&#34;), MONTH)) AS INT64)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="k">CAST</span><span class="p">(</span><span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s2">&#34;%Y&#34;</span><span class="w"> </span><span class="p">,</span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">INT64</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">FORMAT_DATE</span><span class="p">(</span><span class="s2">&#34;%Y&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">INT64</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_age</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">prefecture</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">prefecture</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |pref     |avg_age|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|Miyagi|   51.0|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.5s 13.9KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">other</span><span class="o">-</span><span class="n">code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w">    </span><span class="n">prefecture</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_age</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span></code></pre></div><p>■ practice 11.4 (難易度:低)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">goal_image</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |prob_category|total_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|Tシャツ      |         |
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|Non-Tシャツ  |         |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prob_category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">qty</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">-- CASE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">          </span><span class="c1">--     WHEN REGEXP_CONTAINS(pm.prod_name, r&#34;%Tシャツ%&#34;) THEN &#34;Tシャツ&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">          </span><span class="c1">--     ELSE &#34;Non-Tシャツ&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">          </span><span class="c1">-- END AS prob_category,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">product_id</span><span class="o">&gt;=</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;Tシャツ&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;Non-Tシャツ&#34;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">prob_category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">sp</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |prob_category|total_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|Tシャツ      |     1739|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|Non-Tシャツ  |     1156|
</span></span></span><span class="line"><span class="cl"><span class="c1">--(0.8s 20.2KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="n">prod_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;%Tシャツ%&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="k">TRUE</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;Tシャツ&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="s2">&#34;Non-Tシャツ&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t_shirts_or_not</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t_shirts_or_not</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |prob_category|total_qty|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|Non-Tシャツ  |     1156|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|2|Tシャツ      |     1739|
</span></span></span><span class="line"><span class="cl"><span class="c1">--(0.5s 20.8KB)
</span></span></span></code></pre></div><p>■ practice 11.5 (難易度:低)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-01-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-01-31&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s2">&#34;2018-02-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s2">&#34;2018-02-28&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |f0_|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|  4|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (1.0s 20KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;2018-01-01&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INTERSECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;2018-02-01&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |users|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|    4|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.8s 20KB)
</span></span></span></code></pre></div><p>■ practice 11.6 (難易度:低)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- ||term |min_sales_amount|max_sales_amount|diff_sales_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ||term1|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ||term2|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ||term3|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">((</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">min_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="o">-</span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">COUNT</span><span class="p">(</span><span class="n">purchase_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s2">&#34;2018-01-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-02-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-03-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">min_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="o">-</span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">COUNT</span><span class="p">(</span><span class="n">purchase_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">WHERE</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s2">&#34;2018-05-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-06-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">min_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="o">-</span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff_sales_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">COUNT</span><span class="p">(</span><span class="n">purchase_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_purchase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">WHERE</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s2">&#34;2018-09-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-10-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-12-01&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">month</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="n">QUARTER</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">quarter</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">min_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="o">-</span><span class="k">MIN</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |quarter   |min_sales|max_sales|diff |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|2018-10-01|     1400|    99000|97600|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|2018-07-01|     1600|    90710|89110|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.7s 20KB)
</span></span></span></code></pre></div><h3 id="-難易度中">| 難易度：中<a class="anchor" aria-hidden="true" href="#-難易度中"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>■ practice 11.7(難易度:中)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">--||階級 |度数（階級の個数）|相対度数（構成比）|
</span></span></span><span class="line"><span class="cl"><span class="c1">--||class|frequency         |relative_frequency|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">class</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">class</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">frequency</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="k">class</span><span class="p">)</span><span class="o">/</span><span class="mi">1282</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">relative_frequency</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">30000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">40000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">60000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_6&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">80000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_8&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">90000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_9&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;class_10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="s2">&#34;other&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="mi">3</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |class   |frequency|relative_frequency|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|class_1 |      590|              0.46|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|class_2 |      388|             0.303|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|class_3 |      130|             0.101|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |8|class_10|        7|             0.005|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.4s 10KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">kaikyu</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">dosuu</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="n">dosuu</span><span class="o">/</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">),</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">soutai_dosuu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;0-10000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;10000-20000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">30000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;20000-30000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">40000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;30000-40000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;40000-50000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">60000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;50000-60000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;60000-70000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">80000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;70000-80000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">90000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;80000-90000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">sales_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;90000-100000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="s2">&#34;100000-&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">kaikyu</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dosuu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">kaikyu</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |kaikyu      |dosuu|soutai_dossu|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|0-10000     |  590|        0.46|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|10000-20000 |  388|       0.303|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (1.1s 10KB)
</span></span></span></code></pre></div><p>■ practice 11.8(難易度:中)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_codd</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     prod_name,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     avg_sales_amount - list_price AS diff
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM(SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--          product_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--          ROUND(AVG(sales_amount), 2) AS avg_sales_amount
</span></span></span><span class="line"><span class="cl"><span class="c1">--      FROM `prj-test3.bq_sample.shop_purchases`
</span></span></span><span class="line"><span class="cl"><span class="c1">--      GROUP BY 1
</span></span></span><span class="line"><span class="cl"><span class="c1">--      ORDER BY 1) AS avg_prod
</span></span></span><span class="line"><span class="cl"><span class="c1">-- LEFT OUTER JOIN `prj-test3.bq_sample.products_master` AS pm USING(product_id);
</span></span></span><span class="line"><span class="cl"><span class="c1">-- | |prod_name                      |diff    |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|オックスフォードシャツ 綿 100% |22885.28|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|オックスフォードシャツ 麻混    |19281.67|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pm</span><span class="p">.</span><span class="n">prod_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">(</span><span class="n">ttl_amouont</span><span class="o">/</span><span class="n">ttl_qty</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">aov</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">list_price</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">((</span><span class="n">list_price</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ttl_amouont</span><span class="o">/</span><span class="n">ttl_qty</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">list_price</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">discount_rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_qty</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_amouont</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="c1">--| |product_id|ttl_qty|ttl_amouont|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="c1">--|1|         1|     82|    1536670|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="c1">--|2|         2|     76|    1370940|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |prod_name                            |aov   |list_price|discount_rate|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|Tシャツ（キャラクター・子供用） 長袖|1848.4|      2000|         7.58|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|ポロシャツ 長袖                     |8204.5|      8800|        6.767|
</span></span></span></code></pre></div><p>■ practice 11.10(難易度:中)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;20歳以下&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;21歳~40歳&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;41歳~60歳&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">cu</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;61歳~80歳&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="s2">&#34;81歳以上&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">age_category</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">age</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |age_category|total_amount|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|81歳以上    |      441141|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|20歳以下    |      770006|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.9s 34.6KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cu</span><span class="p">.</span><span class="n">age_group</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;20歳以下&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;21歳~40歳&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;41歳~60歳&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;61歳~80歳&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="s2">&#34;2018-12-31&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">birthday</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;81歳以上&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="s2">&#34;年齢不明&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">age_group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |age_group|sales  |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|21歳~40歳|8985952|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|41歳~60歳|6321162|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |4|20歳以下 | 770006|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (1.0s 34.6KB)
</span></span></span></code></pre></div><p>■ practice 11.11(難易度:中)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">shop_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;2018-02-01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXCEPT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">shop_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;2018-01-01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |product_id|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|         8|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.9s 30KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="n">jan_sales</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">SELECT</span><span class="w"> </span><span class="n">shop_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">WHERE</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;2018-01-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shop_id</span><span class="o">=</span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">feb_sales</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">SELECT</span><span class="w"> </span><span class="n">shop_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">WHERE</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;2018-02-01&#34;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shop_id</span><span class="o">=</span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">shop_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">feb_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXCEPT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">shop_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">jan_sales</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |shop_id|product_id|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|      2|         8|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (1.1s 30KB)
</span></span></span></code></pre></div><h3 id="-難易度高">| 難易度：高<a class="anchor" aria-hidden="true" href="#-難易度高"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h3>
<p>■ practice 11.12(難易度:高)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- |prod_id|prod_name|first_by_sel_qty|rank|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prod_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">*</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="c1">--購入者別
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">purchase_id</span><span class="w"> </span><span class="c1">--購入ID昇順
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ranking</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="c1">-- ||||user_id|||rank|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="c1">-- |||| 733995|||   1|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |product_id|prod_name                    |f0_|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|        10|ブラウス 長袖                | 69|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|        11|Tシャツ（デザイン） 半袖     | 66|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|        13|Tシャツ（キャラクター） 半袖 | 65|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (1.2s 30.9KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pm</span><span class="p">.</span><span class="n">prod_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">first_purchase_item_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">number_of_users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">MAX</span><span class="p">(</span><span class="n">first_purchase_item</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">first_purchase_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="n">first_value</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">purchase_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">first_purchase_item</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">-- | |user_id|first_purchase_item|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">-- |1| 496070|                  2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">fp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- | |user_id|first_purchase_id|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">-- |1| 496070|                2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">fp</span><span class="p">.</span><span class="n">first_purchase_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pm</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">first_purchase_item_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |first_purchase_item_name      |number_of_users|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|ブラウス 長袖                 |             69|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|Tシャツ（デザイン） 半袖      |             66|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|Tシャツ（キャラクター） 半袖  |             65|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (1.2s 30.9KB)
</span></span></span></code></pre></div><p>■ practice 11.13(難易度:高)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">-- ||product_id|count_item|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     product_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     COUNT() AS count_item
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- id20を買った人リスト
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT user_id FROM `prj-test3.bq_sample.shop_purchases` WHERE product_id=20;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- id20しか買ってない人リスト
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT user_id
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM (SELECT *, RANK() OVER( PARTITION BY user_id ORDER BY product_id) AS ranking FROM `prj-test3.bq_sample.shop_purchases`)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- WHERE
</span></span></span><span class="line"><span class="cl"><span class="c1">-- user_id IN (SELECT user_id FROM `prj-test3.bq_sample.shop_purchases` WHERE product_id=20)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- AND
</span></span></span><span class="line"><span class="cl"><span class="c1">-- rank=1 AND product_id=20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ランキングテーブル
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT *, RANK() OVER( PARTITION BY user_id ORDER BY product_id) AS ranking FROM `prj-test3.bq_sample.shop_purchases`;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- id20 かっ複数買った人テーブル
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT *
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM(SELECT *, RANK() OVER( PARTITION BY user_id ORDER BY product_id) AS ranking FROM `prj-test3.bq_sample.shop_purchases`)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- WHERE user_id IN (SELECT user_id FROM `prj-test3.bq_sample.shop_purchases` WHERE product_id=20);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WITH</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ranking</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">*</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="c1">--購入者別
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">                </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="k">ASC</span><span class="w"> </span><span class="c1">--商品ID昇順∵
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pm</span><span class="p">.</span><span class="n">prod_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">market_basket</span><span class="p">.</span><span class="n">count_prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">COUNT</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="n">ranking</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- id20 買った人リスト
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- id20 しか買ってない人リスト
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">user_id</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">FROM</span><span class="w"> </span><span class="n">ranking</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">AND</span><span class="w"> </span><span class="n">product_id</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">product_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">market_basket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pm</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |product_id|prod_name              |count_prod|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|        17|Tシャツ（コラボ） 半袖 |         7|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|         8|ポロシャツ 長袖        |         6|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (2.6s 20.8KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WITH</span><span class="w"> </span><span class="n">purchase_master</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">prodcut_id</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">kaisu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prod1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prod2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">kaisu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">pos1</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">prod1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">pos2</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">prod2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="n">purchase_master</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pos1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">JOIN</span><span class="w"> </span><span class="n">purchase_master</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pos2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">ON</span><span class="w"> </span><span class="n">pos1</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">pos1</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pos2</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">--【 SELF JOIN 】
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="c1">-- | |prod1|prod2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="c1">-- |1|    1|    2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="c1">-- |2|    1|    2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="c1">-- |3|    1|    2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="c1">-- |4|    1|    3|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">prod1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">prod1</span><span class="p">,</span><span class="w"> </span><span class="n">prod2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |prod1|prod2|kaisu|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|   20|   17|    7|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|   20|    8|    6|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.6s 20KB)
</span></span></span></code></pre></div><p>■ practice 11.14(難易度:高)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="p">(</span><span class="n">miss_code</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- WITH
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -- cv uu
</span></span></span><span class="line"><span class="cl"><span class="c1">-- cv_uu AS(
</span></span></span><span class="line"><span class="cl"><span class="c1">--     SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--         DISTINCT user_id
</span></span></span><span class="line"><span class="cl"><span class="c1">--     FROM `prj-test3.bq_sample.shop_purchases`),
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -- logging
</span></span></span><span class="line"><span class="cl"><span class="c1">-- logging AS (
</span></span></span><span class="line"><span class="cl"><span class="c1">--     SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--         *,
</span></span></span><span class="line"><span class="cl"><span class="c1">--         RANK() OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1">--             PARTITION BY user_id
</span></span></span><span class="line"><span class="cl"><span class="c1">--             ORDER BY timestamp ASC
</span></span></span><span class="line"><span class="cl"><span class="c1">--             ) AS user_logging
</span></span></span><span class="line"><span class="cl"><span class="c1">--     FROM `prj-test3.bq_sample.web_usage`)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">-- user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">-- COUNT(user_id) AS uu
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM(SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--             *,
</span></span></span><span class="line"><span class="cl"><span class="c1">--             REGEXP_CONTAINS(lg.page, r&#34;\?&#34;) AS pd
</span></span></span><span class="line"><span class="cl"><span class="c1">--      FROM cv_uu AS cv
</span></span></span><span class="line"><span class="cl"><span class="c1">--      LEFT OUTER JOIN logging AS lg USING(user_id)
</span></span></span><span class="line"><span class="cl"><span class="c1">--      WHERE lg.session_count IS NOT NULL)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- WHERE pd IS TRUE
</span></span></span><span class="line"><span class="cl"><span class="c1">-- GROUP BY 1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">target_user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sp</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sp</span><span class="p">.</span><span class="n">first_date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sp</span><span class="p">.</span><span class="n">first_product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">DATE</span><span class="p">(</span><span class="n">DATETIME_TRUNC</span><span class="p">(</span><span class="n">wu</span><span class="p">.</span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="k">DAY</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">hit_date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">REGEXP_EXTRACT</span><span class="p">(</span><span class="n">wu</span><span class="p">.</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="s2">&#34;\d+$&#34;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">viewd_product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- ユーザー別、初回購入商品ID一覧（重複除去）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">MIN</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">first_date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">MIN</span><span class="p">(</span><span class="n">first_product_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">first_product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">-- ユーザー別、初回購入商品ID一覧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nb">date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">purchase_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">first_product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">--| |user_id|date      |first_product_id|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">--|1| 496070|2018-12-29|               2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">--| |user_id|first_date |first_product_id|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">--|1| 496070|2018-12-29|               2|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">web_usage</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">wu</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">DATE</span><span class="p">(</span><span class="n">DATETIME_TRUNC</span><span class="p">(</span><span class="n">wu</span><span class="p">.</span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="k">DAY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">first_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">REGEXP_EXTRACT</span><span class="p">(</span><span class="n">wu</span><span class="p">.</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="s2">&#34;\d+$&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">first_product_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">STRING</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">--| |user_id|first_date|first_product_id|hit_date  |viewd_product_id|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--|1| 597427|2018-10-20|              17|2018-01-20|17             |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--| |target_user|
</span></span></span><span class="line"><span class="cl"><span class="c1">--|1|        20|
</span></span></span></code></pre></div><p>■ practice 11.15(難易度:高)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="c1">--&lt;A&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     medium,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     COUNT(session_count) AS ss
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM `prj-test3.bq_sample.web_usage`
</span></span></span><span class="line"><span class="cl"><span class="c1">-- GROUP BY medium
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ORDER BY ss DESC;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--&lt;B&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1">--     user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     medium,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     MIN(first_landing) AS first_landing,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     MAX(landing_exit) AS landing_exit,
</span></span></span><span class="line"><span class="cl"><span class="c1">--     MIN(ss_time) AS ss_time
</span></span></span><span class="line"><span class="cl"><span class="c1">-- FROM(
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">-- SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     medium,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     yyyy_mm_dd ,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     FIRST_VALUE(hh_mm_ss) OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         PARTITION BY user_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         ORDER BY timestamp ASC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         ) AS first_landing_time,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     LAST_VALUE(hh_mm_ss) OVER(
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         PARTITION BY user_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         ORDER BY timestamp ASC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         ) AS landing_exit_time,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     -- AS ss_time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">-- FROM(
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     SELECT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         user_id,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         medium,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         timestamp,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         DATE(DATETIME_TRUNC(timestamp, DAY)) AS yyyy_mm_dd,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--         TIME(DATETIME_TRUNC(timestamp, SECOND)) AS hh_mm_ss
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">--     FROM  `prj-test3.bq_sample.web_usage`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">-- );
</span></span></span><span class="line"><span class="cl"><span class="c1">-- )
</span></span></span><span class="line"><span class="cl"><span class="c1">-- GROUP BY 1, 2;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">medium</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="k">session</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">session</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">session_duration</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_duration</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ROUND</span><span class="p">((</span><span class="k">SUM</span><span class="p">(</span><span class="n">session_duration</span><span class="p">)</span><span class="o">/</span><span class="k">SUM</span><span class="p">(</span><span class="k">session</span><span class="p">))</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_session_duration_minute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">medium</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">user_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">STRING</span><span class="p">),</span><span class="w"> </span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">session_count</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">STRING</span><span class="p">)))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">session</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">MIN</span><span class="p">(</span><span class="n">session_duration</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_duration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">session_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">medium</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_count</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">FOLLOWING</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_start_time</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_count</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">FOLLOWING</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_end_time</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">DATETIME_DIFF</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">LAST_VALUE</span><span class="p">(</span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_count</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">FOLLOWING</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">FIRST_VALUE</span><span class="p">(</span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_count</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">FOLLOWING</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">SECOND</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">session_duration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">web_usage</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_count</span><span class="p">,</span><span class="w"> </span><span class="n">medium</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">--| |user_id|session_count|medium  |session_start_time |session_end_time   |session_duration|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">--|1| 855650|            8|referral|2018-08-08T18:48:48|2018-08-08T18:48:48|               0|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">--|2| 916550|            1|organic |2018-10-22T00:46:50|2018-10-22T00:47:31|              41|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="p">,</span><span class="n">session_count</span><span class="p">,</span><span class="w"> </span><span class="n">medium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">-- | |user_id|session_count|medium |session|session_duration|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">-- |1| 989072|            1|organic|      1|             289|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">-- |2| 995450|            4|organic|      1|               0|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">-- |3|1064305|            3|(none) |      1|            2179|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">medium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |medium  |session|session_duration|avg_session_duration_minute|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|social  |     15|            3262|                       3.62|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|organic |    556|          112432|                       3.37|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |3|referral|     84|           13741|                       2.73|
</span></span></span></code></pre></div><p>Cf.<a href="https://www.dbonline.jp/sqlite/function/index6.html">日付と時刻を取得する(date関数, time関数, datetime関数, julianday関数, strftime関数)</a></p>
<p>■ practice 11.16(難易度:高)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">transaction_user</span><span class="w"> </span><span class="k">AS</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">--ネット購入者リスト
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">MIN</span><span class="p">(</span><span class="n">transaction_product</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">transaction_product</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">transaction_product</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">web_usage</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">transaction_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shop_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prod_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">--リアル店舗購入者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">transaction_user</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cv</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cv</span><span class="p">.</span><span class="n">transaction_product</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">AND</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sp</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="p">.</span><span class="n">transaction_product</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shops_master</span><span class="o">`</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">products_master</span><span class="o">`</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="n">product_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | |user_id|last_name|first_name|shop_name   |product_id|prod_name          |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |1|1000380|浅井      |忠        |自由が丘店|         3|開襟シャツ 綿 100%  |
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |2|1011670|度會      |咲耶      |下北沢店  |        16|Tシャツ（漢字） 長袖|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- (0.9s 78.7KB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- answer -----------------------------------------------------
</span></span></span></code></pre></div>
  <p></p>
</details>

<h4 id="section12-おまけ">SECTION12 ：おまけ<a class="anchor" aria-hidden="true" href="#section12-おまけ"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h4>
<details>
  <summary></summary>
  <p></p>
  <p><img src="https://i.gyazo.com/625fcf38f301105c0dbc76da5b9951ff.png" alt="Google DataPortal"></p>
<p>これまでのsectionで学んできたデータを、</p>
<p>テーブルデータとしてではなく視覚的に伝えやすくする方法が可視化です。</p>
<ol>
<li>SQLをBigQueryに書く。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sp</span><span class="p">.</span><span class="n">year_month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sm</span><span class="p">.</span><span class="n">shop_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sp</span><span class="p">.</span><span class="n">ttl_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="k">MONTH</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">year_month</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">shop_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ttl_sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shop_purchases</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="n">shop_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">prj</span><span class="o">-</span><span class="n">test3</span><span class="p">.</span><span class="n">bq_sample</span><span class="p">.</span><span class="n">shops_master</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="p">(</span><span class="n">shop_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>BigQuery上で、求めたいデータを抽出する。
<img src="https://i.gyazo.com/d672afedd1bcc9c0678bbba6ff5bb9dd.png" alt="biqquery_editer"></li>
</ol>
<pre tabindex="0"><code>表示画面の上部のナビゲーションから、「データを探索」をプルダウン。
そのまま、データポータルへ遷移。
</code></pre><ol start="3">
<li>Google DataPortal
<img src="https://i.gyazo.com/625fcf38f301105c0dbc76da5b9951ff.png" alt="Google DataPortal"></li>
</ol>
<pre tabindex="0"><code>よかったら以下にリンクを貼っておきますので、覗いてみてください。
こんな感じにお洒落になりました。
</code></pre><p><a href="https://datastudio.google.com/reporting/fa043ba1-256c-49a9-8f1b-bf12bf5295fa">🔗 作成したデータポータルはこちら &gt;</a></p>

  <p></p>
</details>

<h2 id="ref">Ref.<a class="anchor" aria-hidden="true" href="#ref"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> </h2>
<ul>
<li><a href="https://cloud.google.com/bigquery/docs/how-to">入門ガイド</a> GoogleCloud</li>
<li><a href=""></a></li>
</ul>
</article>
        </div>
        </div>
        </div>
    </div>
        
        
        
        <div class="Box mt-3 position-relative">
        <div class="Box-body px-5 pb-5">
            <article class="markdown-body entry-content container-lg">
                <h2>See Also</h2>
                <ul class="mt-2">
                    
                    <li class="p-1">
                        <div>
                            <a href="../../post/bigquery_about_data_quality/">[BigQuery] Data Quality</a>
                            <time datetime="2024-10-16 13:49" class="no-wrap text-small ml-1">(2024-10-16 13:49)</time>
                        </div>
                        <div class="text-small text-gray mb-1 mt-1">Different perspective from data analysis. About data quality.</div>
                    </li>
                    
                    <li class="p-1">
                        <div>
                            <a href="../../post/bigquery_used_functions/">[BigQuery] Used in functions</a>
                            <time datetime="2024-08-29 19:47" class="no-wrap text-small ml-1">(2024-08-29 19:47)</time>
                        </div>
                        <div class="text-small text-gray mb-1 mt-1">When I getting from my daily work. Added as need. I keep writing various tips.</div>
                    </li>
                    
                    <li class="p-1">
                        <div>
                            <a href="../../post/bigquery_structured_data_processing_100/">[BigQuery] Structured data processing 100&#39;s</a>
                            <time datetime="2024-07-26 04:23" class="no-wrap text-small ml-1">(2024-07-26 04:23)</time>
                        </div>
                        <div class="text-small text-gray mb-1 mt-1">Tried using SQL to learn the basics of data science.</div>
                    </li>
                    
                    <li class="p-1">
                        <div>
                            <a href="../../post/bigquery_data_analysis_on_cte/">[BigQuery] CTEs in data analyisis</a>
                            <time datetime="2024-07-20 16:13" class="no-wrap text-small ml-1">(2024-07-20 16:13)</time>
                        </div>
                        <div class="text-small text-gray mb-1 mt-1">Things to keep in mind when analyzing data using SQL.</div>
                    </li>
                    
                    <li class="p-1">
                        <div>
                            <a href="../../post/bigquery_billing_how_works/">[BigQuery] Billing</a>
                            <time datetime="2024-08-16 20:35" class="no-wrap text-small ml-1">(2024-08-16 20:35)</time>
                        </div>
                        <div class="text-small text-gray mb-1 mt-1">Summarize billing mechanism, fee structure, and money-saving tips.</div>
                    </li>
                    
                </ul>
            </article>
        </div>
        </div>
        
    </div>
    </div>
</main>
</div>

<script type="application/javascript" src='https://shiroimon.kithub.f5.si/js/toc.js'></script>
<link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/toc.css' />


<script
    src='https://shiroimon.kithub.f5.si/js/syntax-highlight-title.js'
    crossorigin="anonymous"
    type="application/javascript">
</script>
<link rel="stylesheet" href="../../css/syntax-highlight-title.css">









<script src="https://unpkg.com/mermaid@11/dist/mermaid.min.js" crossorigin="anonymous"></script>
<script>


(function () {
    function transformMermaidCodeBlocks() {
        var codeBlocks = document.querySelectorAll('pre > code.language-mermaid, code.language-mermaid');
        codeBlocks.forEach(function (code) {
            var pre = code.parentElement && code.parentElement.tagName.toLowerCase() === 'pre' ? code.parentElement : code;
            var container = document.createElement('div');
            container.className = 'mermaid';
            container.textContent = code.textContent;
            pre.replaceWith(container);
        });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', transformMermaidCodeBlocks);
    } else {
        transformMermaidCodeBlocks();
    }
    
    if (window.mermaid) {
        window.mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    }
})();
</script>




  
  
  
  
  
  
    
  
<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://shiroimon.kithub.f5.si/css/gitalk.css'>
<script src='https://shiroimon.kithub.f5.si/js/gitalk.min.js'></script>
<script>
  const gitalk = new Gitalk({
    clientID: 'Ov23limCcfAvRdvUJ1de',
    clientSecret: '08c9365618f3a7434fe608970e757bba3d2369bc',
    repo: 'todayilearned',
    owner: 'shiroimon',
    admin: ["shiroimon"],
    labels: ["gitalk"],
    perPage:  10 ,
    pagerDirection: 'last',
    createIssueManually:  false ,
    distractionFreeMode:  false ,
    id: 'b000f2f56d080bc74ce9e6e6f7698646'
  });
  gitalk.render('gitalk-container');
</script>



</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://shiroimon.kithub.f5.si/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://shiroimon.kithub.f5.si/js/github-style.js"></script>





<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
<script type="application/javascript" src='https://shiroimon.kithub.f5.si/js/search.js'></script>



</html>